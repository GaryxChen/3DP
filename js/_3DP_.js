function extend(e,r){e.prototype=new r,e.prototype.constructor=e}this.setTimeout=setTimeout||window.setTimeout,this.Math=Math,this.console.log=console.log,this.alert=alert,this.FloatArray=Float32Array,this.IntArray=Int32Array,this.UintArray=Uint16Array;var _3DP_TYPE={CANVAS:null,MODEL:null,TEXTURE:null,SHADER:null,CAMERA:null,RENDER_OBJECT:null},enumCount=1;for(var i in _3DP_TYPE)_3DP_TYPE[i]=enumCount,enumCount++;var _3DP_SHADER_INPUT={FLOAT:0,FLOAT2:1,FLOAT3:2,FLOAT4:3,FLOAT_VECTOR:4,FLOAT2_VECTOR:5,FLOAT3_VECTOR:6,FLOAT4_VECTOR:7,INT:8,INT2:9,INT3:10,INT4:11,INT_VECTOR:12,INT2_VECTOR:13,INT3_VECTOR:14,INT4_VECTOR:15,MATRIX2:16,MATRIX3:17,MATRIX4:18,TEXTURE:19,VERTEX_ATTRIBUTE:20},_3DP_GLOBAL_ID=0,setId=function(){return _3DP_GLOBAL_ID+=1},_3DP_Helper;function _3DP_BaseComponent(){this._3DP_ID=null,this._3DP_TYPE=null,this.init=function(){}}function _3DP_Canvas(e){var r={ID:setId(),TYPE:_3DP_TYPE.CANVAS,RAWDATA:null,RESOURCE:null};this.init=function(){this._3DP_ID=r.ID,this._3DP_TYPE=r.TYPE},this.get3DPId=function(){return r.ID},this.get3DPType=function(){return r.TYPE},this.getCanvas=function(){return r.RAWDATA},this.getWebGL=function(){return r.RESOURCE},this.getMember=function(){return r},this.init()}function _3DP_Resource(){this.isUsing=!1,this.countUse=0}function _3DP_Camera(){var e={ID:setId(),TYPE:_3DP_TYPE.CAMERA};this.init=function(){this._3DP_ID=e.ID,this._3DP_TYPE=e.TYPE},this.get3DPId=function(){return e.ID},this.get3DPType=function(){return e.TYPE},this.getMember=function(){return e},this.getViewMatrix=function(){return _3DP_Helper.lookAt(this.position,this.lookAt,this.up)},this.getProjectionMatrix=function(e){return e=e||1,_3DP_Helper.perspective(this.viewAngle,e,this.neapPlane,this.farPlane)},this.position=[0,0,10],this.up=[0,1,0],this.lookAt=[0,0,0],this.viewAngle=45,this.neapPlane=.001,this.farPlane=1e3,this.viewportStartX=0,this.viewportStartY=0,this.viewportEndX=null,this.viewportEndY=null,this.active=!0,this.init()}function _3DP_Model(){var e={ID:setId(),TYPE:_3DP_TYPE.MODEL,RAWDATA:{VERTEX:[],NORMAL:[],TEXTURE_COORDINATE:[],INDEX:[],EXTRA:{}},RESOURCE:{VERTEX:null,NORMAL:null,TEXTURE_COORDINATE:null,INDEX:null,EXTRA:{}}};this.init=function(){this._3DP_ID=e.ID,this._3DP_TYPE=e.TYPE},this.get3DPId=function(){return e.ID},this.get3DPType=function(){return e.TYPE},this.getMember=function(){return e},this.getModelRawData=function(){return e.RAWDATA},this.setExtraData=function(r,t){t.length==e.RAWDATA.VERTEX.length?e.RAWDATA.EXTRA[r]=t:console.log("Vertex額外資料數量必須與vertex數量相同，未設定任何資料")},this.getExtraData=function(r){return e.RESOURCE.EXTRA[r]},this.init()}function _3DP_Texture(){var e={ID:setId(),TYPE:_3DP_TYPE.TEXTURE,RAWDATA:null,RESOURCE:null};this.init=function(){this._3DP_ID=e.ID,this._3DP_TYPE=e.TYPE},this.get3DPId=function(){return e.ID},this.get3DPType=function(){return e.TYPE},this.getMember=function(){return e},this.init()}function _3DP_Shader(){var e={ID:setId(),TYPE:_3DP_TYPE.SHADER,RAWDATA:{VERTEX_SHADER:null,FRAGMENT_SHADER:null,SHADER_INPUT:{}},RESOURCE:{PROGRAM:null,LOC:{VERTEX:-1,NORMAL:-1,TEXTURE_COORDINATE:-1,TRANSFORM_MATRIX:null,VIEW_MATRIX:null,PROJECTION_MATRIX:null,SHADER_INPUT:{}}}};this.init=function(){this._3DP_ID=e.ID,this._3DP_TYPE=e.TYPE},this.get3DPId=function(){return e.ID},this.get3DPType=function(){return e.TYPE},this.getMember=function(){return e},this.init()}function _3DP_RenderObject(){var e={ID:setId(),TYPE:_3DP_TYPE.RENDER_OBJECT,ELEMENT:{MODEL:null,SHADER:null,SHADER_INPUT:{},TRANSFORM_MATRIX:[]}};this.init=function(){this._3DP_ID=e.ID,this._3DP_TYPE=e.TYPE,e.ELEMENT.TRANSFORM_MATRIX=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]},this.get3DPId=function(){return e.ID},this.get3DPType=function(){return e.TYPE},this.getMember=function(){return e},this.setTransformMatrix=function(r){e.ELEMENT.TRANSFORM_MATRIX=r},this.getTransformMatrix=function(){return e.ELEMENT.TRANSFORM_MATRIX},this.setModel=function(r){_3DP_Helper.checkType(r,_3DP_TYPE.MODEL)?e.ELEMENT.MODEL=r:console.log(r+" 不是Model，使用預設Model")},this.setShader=function(r){_3DP_Helper.checkType(r,_3DP_TYPE.SHADER)?e.ELEMENT.SHADER=r:console.log(r+" 不是Shader，使用預設Shader")},this.setShaderInput=function(r,t){e.ELEMENT.SHADER_INPUT[r]={},e.ELEMENT.SHADER_INPUT[r].DATA=t},this.clearShaderInput=function(){e.ELEMENT.SHADER_INPUT={}},this.active=!0,this.init()}function wizard(e){var r={cameraManager:null,canvasController:null,fileLoader:null,frameController:null,modelManager:null,renderController:null,resourceManager:null,sceneManager:null,shaderManager:null,textureManager:null};r.canvasController=new _3DP_CanvasController,r.canvasController.init(e),r.renderController=new _3DP_RenderController,r.renderController.init(r.canvasController),r.cameraManager=new _3DP_CameraManager,r.cameraManager.init(),r.fileLoader=new _3DP_FileLoader,r.fileLoader.init(),r.frameController=new _3DP_FrameController,r.frameController.init(r.renderController),r.modelManager=new _3DP_ModelManager,r.modelManager.init(r.canvasController),r.resourceManager=new _3DP_ResourceManager,r.resourceManager.init(),r.sceneManager=new _3DP_SceneManager,r.sceneManager.init(),r.shaderManager=new _3DP_ShaderManager,r.shaderManager.init(r.canvasController),r.textureManager=new _3DP_TextureManager,r.textureManager.init(r.canvasController),this.getCameraManager=function(){return r.cameraManager},this.getCanvasController=function(){return r.canvasController},this.getFileLoader=function(){return r.fileLoader},this.getFrameController=function(){return r.frameController},this.getModelManager=function(){return r.modelManager},this.getRenderController=function(){return r.renderController},this.getResourceManager=function(){return r.resourceManager},this.getSceneManager=function(){return r.sceneManager},this.getShaderManager=function(){return r.shaderManager},this.getTextureManager=function(){return r.textureManager}}function _3DP_CameraManager(){var e={maintainList:{},cameraList:[]};this.add=function(r){e.maintainList[r._3DP_ID]=r,e.cameraList.push(r)},this.remove=function(r){delete e.maintainList[r._3DP_ID]},this.refreshCameraList=function(){var r=e.cameraList,t=e.maintainList;for(var n in r=[],t)r.push(t[n])},this.sortCameraList=function(){},this.getCameraList=function(){return e.cameraList}}function _3DP_CanvasController(){var e={canvas:null};this.init=function(r){for(var t=["webgl","webkit-3d","moz-webgl","experimental-webgl"],n=!1,o=0;o<4;o++){try{var n=r.getContext(t[o])}catch(e){console.log(e),n=!1}if(n)break}if(!n)return _3DP_Helper.criticalError("此瀏覽器不支援WebGL，請改用有支援的瀏覽器。如Chrome"),!1;var i=new _3DP_Canvas;i.getMember().RAWDATA=r,i.getMember().RESOURCE=n,e.canvas=i},this.getCanvas=function(){return e.canvas}}function _3DP_FileLoader(){var e={callBack:null};this.init=function(){e.callBack=function(e,r){console.log("未設置callback function, 格式為fun(_result, _argArray)")}},this.loadObjModel=async function(r,t,n){t=t||e.callBack;let o=await fetch(r),i;for(var a=await o.text(),A=[],l=[],_=[],T=[],u=/v\s.*/g,c=/vt\s.*/g,E=/vn\s.*/g,D=/f\s.*/g,s=a.match(u),R=a.match(c),P=a.match(E),g=a.match(D),f=0;f<s.length;f++){var C=s[f].match(/[-.0-9]+/g);s[f]=[1*C[0],1*C[1],1*C[2]]}for(var f=0;f<R.length;f++){var C=R[f].match(/[-.0-9]+/g);R[f]=[1*C[0],1*C[1]]}for(var f=0;f<P.length;f++){var C=P[f].match(/[-.0-9]+/g);P[f]=[1*C[0],1*C[1],1*C[2]]}for(var f=0;f<g.length;f++){for(var C,K=(C=g[f].match(/[\/0-9]+/g)).length,h=0;h<K;h++){var M=C[h].split("/");A.push(s[1*M[0]-1]),R.length>0?l.push(R[1*M[1]-1]):l.push([0,0]),P.length>0?_.push(P[1*M[2]-1]):_.push([0,0,0])}for(var m=A.length,d=K-2,h=0;h<d;h++){var O=m-K;T.push([O,O+h+1,O+h+2])}}var I=new _3DP_Model,v=I.getMember().RAWDATA;v.VERTEX=A,v.TEXTURE_COORDINATE=l,v.NORMAL=_,v.INDEX=T,t(I,n=n||[])},this.loadShader=async function(r,t,n,o){n=n||e.callBack;var i=new _3DP_Shader,a=i.getMember().RAWDATA;let A=await fetch(r),l=await fetch(t);a.VERTEX_SHADER=await A.text(),a.FRAGMENT_SHADER=await l.text(),n(i,o=o||[])},this.loadTexture=function(r,t,n){t=t||e.callBack;var o=new Image;o.onload=function(){var e=new _3DP_Texture;e.getMember().RAWDATA=o,t(e,n=n||[])},o.src=r},this.init()}function _3DP_FrameController(){var e={renderController:null,frameFun:_3DP_Helper.emptyFunction,timeoutFun:null,frameStartTime:0,everFrameWaitTime:33,isPlay:!1,calculateFPSFun:null,isCalculateFPS:!1,FPS:0,countFPS:0,preFPSTime:0};this.init=function(r){e.renderController=r},this.setFPS=function(r){e.everFrameWaitTime=r<=0?1e3:Math.round(1e3/r)},e.calculateFPSFun=function(){e.countFPS++;var r=e.countFPS,t=_3DP_Helper.getTime()-e.preFPSTime;t>=1e3&&(e.preFPSTime=_3DP_Helper.getTime(),e.countFPS=0),t<=0&&(t=1),e.FPS=Math.round(r/t*1e5)/100},this.FPS=function(){return e.FPS},this.calculateFPS=function(r){r?e.isCalculateFPS=!0:(e.isCalculateFPS=!1,e.FPS=0,e.countFPS=0)},this.setFrameFunction=function(r){e.frameFun=r},e.timeoutFun=function(){var r=e.renderController;if(0!=e.isPlay&&null!=r){e.frameStartTime=_3DP_Helper.getTime(),e.frameFun(),r.renderAll(),r.waitComplete(),e.isCalculateFPS&&e.calculateFPSFun();var t=e.everFrameWaitTime-(_3DP_Helper.getTime()-e.frameStartTime);setTimeout(e.timeoutFun,t)}else null==r&&_3DP_Helper.criticalError("_3DP_FrameController未完成初始化，_3DP_FrameController.init(instance _3DP_RenderController)")},this.start=function(){e.isPlay=!0,e.timeoutFun()},this.stop=function(){e.isPlay=!1}}function _3DP_ModelManager(){var e={canvas:null,DEFAULT:null,createBuffer:null};this.init=function(r){e.canvas=r.getCanvas();var t=_3DP_Helper.createPlane();e.DEFAULT=this.add(t)},e.createBuffer=function(r,t,n){n=n||!1;var o=e.canvas.getWebGL(),i=o.createBuffer(),a=_3DP_Helper.flatArray(r);return n?(o.bindBuffer(o.ELEMENT_ARRAY_BUFFER,i),o.bufferData(o.ELEMENT_ARRAY_BUFFER,new t(a),o.STATIC_DRAW),i.SIZE=a.length,i):(o.bindBuffer(o.ARRAY_BUFFER,i),o.bufferData(o.ARRAY_BUFFER,new t(a),o.STATIC_DRAW),i.SIZE=r[0].length,i)},this.add=function(r){if(!_3DP_Helper.checkType(r,_3DP_TYPE.MODEL))return console.log(r+" ,ModelManager不支援的資料類別，使用預設資源"),e.DEFAULT;var t=r.getMember().RESOURCE,n=r.getMember().RAWDATA;if(null==n.VERTEX||null==n.INDEX)return console.log(r+" ,Model資料不完整，使用預設資源"),e.DEFAULT;for(var o in t.VERTEX=e.createBuffer(n.VERTEX,FloatArray),t.INDEX=e.createBuffer(n.INDEX,UintArray,!0),null!=n.NORMAL&&(t.NORMAL=e.createBuffer(n.NORMAL,FloatArray)),null!=n.TEXTURE_COORDINATE&&(t.TEXTURE_COORDINATE=e.createBuffer(n.TEXTURE_COORDINATE,FloatArray)),n.EXTRA)t.EXTRA[o]=e.createBuffer(n.EXTRA[o],FloatArray);return r},this.remove=function(e){if(_3DP_Helper.checkType(e,_3DP_TYPE.MODEL))var r=e.getResource();else console.log(e+" ,ModelManager不支援的資料類別，未移除任何資源")}}function _3DP_RenderController(){var e={canvas:null,draw:null,renderPreProcess:null,shaderInput:null,textureUnitArray:[],renderList:[],cameraList:[],randerTarget:null,cameraCheck:!0,renderObjectCheck:!0};this.init=function(r){e.canvas=r.getCanvas();var t=e.canvas.getWebGL();t.enable(t.DEPTH_TEST),t.frontFace(t.CCW),t.disable(t.CULL_FACE),t.cullFace(t.BACK);for(var n=0;n<t.getParameter(t.MAX_COMBINED_TEXTURE_IMAGE_UNITS);n++)e.textureUnitArray.push(t.TEXTURE0+n);this.setClearFrame(!0,!0,!1)},this.setRenderObjectList=function(r){r instanceof Array?e.renderList=r:console.log("RenderController.setRenderObjectList(array of instance _3DP_RenderObject)錯誤，輸入為Array資料類別，未輸入任何資料")},this.setCameraList=function(r){r instanceof Array?e.cameraList=r:console.log("RenderController.setCameraList(array of instance _3DP_Camera)錯誤，輸入為Array資料類別，未輸入任何資料")},e.shaderInput=function(r){var t=e.canvas.getWebGL(),n=r.SHADER.getMember().RESOURCE.LOC.SHADER_INPUT,o=r.SHADER_INPUT,i=_3DP_SHADER_INPUT,a=0;for(var A in n)if(null!=o[A])switch(n[A].TYPE){case i.FLOAT:t.uniform1f(n[A].LOC,o[A].DATA);break;case i.FLOAT2:t.uniform2f(n[A].LOC,o[A].DATA[0],o[A].DATA[1]);break;case i.FLOAT3:t.uniform3f(n[A].LOC,o[A].DATA[0],o[A].DATA[1],o[A].DATA[2]);break;case i.FLOAT4:t.uniform4f(n[A].LOC,o[A].DATA[0],o[A].DATA[1],o[A].DATA[2],o[A].DATA[3]);break;case i.FLOAT_VECTOR:t.uniform1fv(n[A].LOC,_3DP_Helper.flatArray(o[A].DATA));break;case i.FLOAT2_VECTOR:t.uniform2fv(n[A].LOC,_3DP_Helper.flatArray(o[A].DATA));break;case i.FLOAT3_VECTOR:t.uniform3fv(n[A].LOC,_3DP_Helper.flatArray(o[A].DATA));break;case i.FLOAT4_VECTOR:t.uniform4fv(n[A].LOC,_3DP_Helper.flatArray(o[A].DATA));break;case i.INT:t.uniform1i(n[A].LOC,o[A].DATA);break;case i.INT2:t.uniform2i(n[A].LOC,o[A].DATA[0],o[A].DATA[1]);break;case i.INT3:t.uniform3i(n[A].LOC,o[A].DATA[0],o[A].DATA[1],o[A].DATA[2]);break;case i.INT4:t.uniform4i(n[A].LOC,o[A].DATA[0],o[A].DATA[1],o[A].DATA[2],o[A].DATA[3]);break;case i.INT_VECTOR:t.uniform1iv(n[A].LOC,_3DP_Helper.flatArray(o[A].DATA));break;case i.INT2_VECTOR:t.uniform2iv(n[A].LOC,_3DP_Helper.flatArray(o[A].DATA));break;case i.INT3_VECTOR:t.uniform3iv(n[A].LOC,_3DP_Helper.flatArray(o[A].DATA));break;case i.INT4_VECTOR:t.uniform4iv(n[A].LOC,_3DP_Helper.flatArray(o[A].DATA));break;case i.MATRIX2:t.uniformMatrix2fv(n[A].LOC,_3DP_Helper.flatArray(o[A].DATA));break;case i.MATRIX3:t.uniformMatrix3fv(n[A].LOC,_3DP_Helper.flatArray(o[A].DATA));break;case i.MATRIX4:t.uniformMatrix4fv(n[A].LOC,_3DP_Helper.flatArray(o[A].DATA));break;case i.TEXTURE:var l=e.textureUnitArray;if(a>=l.length){console.log("Texture最多只能"+l.length+"張");break}t.activeTexture(l[a]),t.bindTexture(t.TEXTURE_2D,o[A].DATA.getMember().RESOURCE),t.uniform1i(n[A].LOC,a),a+=1;break;case i.VERTEX_ATTRIBUTE:var _=r.MODEL.getMember().RESOURCE.EXTRA[A];n[A].LOC>-1&&null!=_&&(t.bindBuffer(t.ARRAY_BUFFER,_),t.vertexAttribPointer(n[A].LOC,_.SIZE,t.FLOAT,!1,0,0))}},e.draw=function(r,t,n){var o=e.canvas.getWebGL(),i=r.MODEL.getMember().RESOURCE,a=i.VERTEX,A=i.INDEX,l=i.NORMAL,_=i.TEXTURE_COORDINATE,T=r.SHADER.getMember().RESOURCE.LOC;o.useProgram(r.SHADER.getMember().RESOURCE.PROGRAM),o.bindBuffer(o.ARRAY_BUFFER,a),o.vertexAttribPointer(T.VERTEX,a.SIZE,o.FLOAT,!1,0,0),T.NORMAL>-1&&null!=l&&(o.bindBuffer(o.ARRAY_BUFFER,l),o.vertexAttribPointer(T.NORMAL,l.SIZE,o.FLOAT,!1,0,0)),T.TEXTURE_COORDINATE>-1&&null!=_&&(o.bindBuffer(o.ARRAY_BUFFER,_),o.vertexAttribPointer(T.TEXTURE_COORDINATE,_.SIZE,o.FLOAT,!1,0,0)),o.uniformMatrix4fv(T.TRANSFORM_MATRIX,!1,r.TRANSFORM_MATRIX),o.uniformMatrix4fv(T.VIEW_MATRIX,!1,t),o.uniformMatrix4fv(T.PROJECTION_MATRIX,!1,n),o.bindBuffer(o.ELEMENT_ARRAY_BUFFER,A),e.shaderInput(r),o.drawElements(o.TRIANGLES,A.SIZE,o.UNSIGNED_SHORT,0)},e.renderPreProcess=function(r,t){for(var n=e.renderList,o=n.length,i=0;i<o;i++)if(0!=n[i].active){var a=n[i].getMember().ELEMENT;if(o<=0)return void(e.renderObjectCheck&&(console.log("RenderController未設置任何RenderObject，RenderController.setRenderObjectList(array of instance _3DP_RenderObject)"),e.renderObjectCheck=!1));null!=a.MODEL&&null!=a.SHADER?e.draw(a,r,t):(console.log(n[i]+"Render Object資料不完整, 停止處理此物件"),n[i].active=!1)}},this.renderAll=function(){var r=e.cameraList,t=e.cameraList.length,n=e.renderPreProcess;if(t<=0)e.cameraCheck&&(console.log("RenderController未設置任何攝影機，RenderController.setCameraList(array of instance _3DP_Camera)"),e.cameraCheck=!1);else for(var o=e.canvas.getWebGL(),i=0;i<t;i++){var a=r[i].viewportStartX,A=r[i].viewportEndX,l=r[i].viewportStartY,_=r[i].viewportEndY;null==A&&(r[i].viewportEndX=e.canvas.getCanvas().width),null==_&&(r[i].viewportEndY=e.canvas.getCanvas().height),o.viewport(a,l,A,_),n(r[i].getViewMatrix(),r[i].getProjectionMatrix(Math.abs((A-a)/(_-l))))}},this.waitComplete=function(){},this.setClearFrame=function(r,t,n){var o=e.canvas.getWebGL();r&&o.clear(o.COLOR_BUFFER_BIT),t&&o.clear(o.DEPTH_BUFFER_BIT),n&&o.clear(o.STENCIL_BUFFER_BIT)},this.setRanderTarget=function(r){e.randerTarget=r},this.getRanderTarget=function(){return e.randerTarget},this.assignRanderTarget=function(){var r=e.canvas.getWebGL();r.bindFramebuffer(r.FRAMEBUFFER,e.randerTarget)}}function _3DP_ResourceManager(){this.init=function(){},this.remove=function(e){}}function _3DP_SceneManager(){var e={maintainList:{},renderObjectList:[]};this.add=function(r){_3DP_Helper.checkType(r,_3DP_TYPE.RENDER_OBJECT)?(e.maintainList[r.get3DPId()]=r,e.renderObjectList.push(r)):console.log(r+" SceneManager不支援的資料類別，未加入任何資源")},this.remove=function(r){delete e.maintainList[r.get3DPId()]},this.clear=function(){e.renderObjectList=[]},this.refreshRenderObjectList=function(){var r=e.renderObjectList,t=e.maintainList;for(var n in r=[],t)r.push(t[n])},this.sortRenderObjectList=function(){},this.getRenderObjectList=function(){return e.renderObjectList}}function _3DP_ShaderManager(){var e={canvas:null,DEFAULT:null,compileShader:null,programShader:null,getShaderLoc:null,shaderInputProcess:null,defaultVS:null,defaultFS:null,defaultVS:function(){var e;return"attribute vec3 aVertex;uniform mat4 uTransformMatrix;uniform mat4 uViewMatrix;uniform mat4 uProjectionMatrix;void main(void) {gl_Position = uProjectionMatrix * uViewMatrix * uTransformMatrix * vec4(aVertex, 1.0);}"},defaultFS:function(){var e;return"void main(void) {gl_FragColor = vec4(1.0, 0.0, 1.0, 1.0);}"}};this.init=function(r){e.canvas=r.getCanvas();var t=new _3DP_Shader,n=t.getMember().RAWDATA;n.VERTEX_SHADER=e.defaultVS(),n.FRAGMENT_SHADER=e.defaultFS(),e.DEFAULT=this.add(t)},e.compileShader=function(r,t){var n=e.canvas.getWebGL(),o=n.createShader(t);return n.shaderSource(o,r),n.compileShader(o),n.getShaderParameter(o,n.COMPILE_STATUS)?o:(console.log(n.getShaderInfoLog(o)),!1)},e.programShader=function(r,t){var n=e.canvas.getWebGL(),o=n.createProgram();return n.attachShader(o,r),n.attachShader(o,t),n.linkProgram(o),n.detachShader(o,r),n.detachShader(o,t),o},e.getShaderLoc=function(r){var t=e.canvas.getWebGL(),n=r.getMember().RESOURCE.PROGRAM,o=r.getMember().RESOURCE.LOC;if(o.VERTEX=t.getAttribLocation(n,"aVertex"),o.VERTEX<0)return console.log(r+" ,Shader沒有 aVertex 變數，此為必要變數，使用預設資源"),void(r=e.DEFAULT);if(o.NORMAL=t.getAttribLocation(n,"aNormal"),o.TEXTURE_COORDINATE=t.getAttribLocation(n,"aTextureCoordinate"),o.VERTEX>-1&&t.enableVertexAttribArray(o.VERTEX),o.NORMAL>-1&&t.enableVertexAttribArray(o.NORMAL),o.TEXTURE_COORDINATE>-1&&t.enableVertexAttribArray(o.TEXTURE_COORDINATE),o.TRANSFORM_MATRIX=t.getUniformLocation(n,"uTransformMatrix"),null==o.TRANSFORM_MATRIX)return console.log(r+" ,Shader沒有 uTransformMatrix 變數，此為必要變數，使用預設資源"),void(r=e.DEFAULT);if(o.VIEW_MATRIX=t.getUniformLocation(n,"uViewMatrix"),null==o.VIEW_MATRIX)return console.log(r+" ,Shader沒有 uViewMatrix 變數，此為必要變數，使用預設資源"),void(r=e.DEFAULT);if(o.PROJECTION_MATRIX=t.getUniformLocation(n,"uProjectionMatrix"),null==o.PROJECTION_MATRIX)return console.log(r+" ,Shader沒有 uProjectionMatrix 變數，此為必要變數，使用預設資源"),void(r=e.DEFAULT);var i=r.getMember().RAWDATA.SHADER_INPUT,a=r.getMember().RESOURCE.LOC.SHADER_INPUT,A=_3DP_SHADER_INPUT;for(var l in i)a[l]={},a[l].TYPE=i[l].TYPE,a[l].TYPE==A.VERTEX_ATTRIBUTE?(a[l].LOC=t.getAttribLocation(n,l),a[l].LOC>-1&&t.enableVertexAttribArray(a[l].LOC)):a[l].LOC=t.getUniformLocation(n,l)},e.shaderInputProcess=function(e){var r=e.getMember().RAWDATA.VERTEX_SHADER,t=e.getMember().RAWDATA.FRAGMENT_SHADER,n=e.getMember().RAWDATA.SHADER_INPUT,o=_3DP_SHADER_INPUT,i=function(e){return(r.match(e)||[]).concat(t.match(e)||[])},a=function(e,r){for(var t=[],o=0;o<r.length;o++){var i=r[o].match(/[0-9a-zA-Z_]+/g)||[];i.shift(),t=t.concat(i)}for(var o=0;o<t.length;o++)n[t[o]]={},n[t[o]].TYPE=e},A={};for(var l in A[o.FLOAT]=i(/#3DP_FLOAT\s+.*/g),A[o.FLOAT2]=i(/#3DP_FLOAT2\s+.*/g),A[o.FLOAT3]=i(/#3DP_FLOAT3\s+.*/g),A[o.FLOAT4]=i(/#3DP_FLOAT4\s+.*/g),A[o.FLOAT_VECTOR]=i(/#3DP_FLOAT_VECTOR\s+.*/g),A[o.FLOAT2_VECTOR]=i(/#3DP_FLOAT2_VECTOR\s+.*/g),A[o.FLOAT3_VECTOR]=i(/#3DP_FLOAT3_VECTOR\s+.*/g),A[o.FLOAT4_VECTOR]=i(/#3DP_FLOAT4_VECTOR\s+.*/g),A[o.INT]=i(/#3DP_INT\s+.*/g),A[o.INT2]=i(/#3DP_INT2\s+.*/g),A[o.INT3]=i(/#3DP_INT3\s+.*/g),A[o.INT4]=i(/#3DP_INT4\s+.*/g),A[o.INT_VECTOR]=i(/#3DP_INT_VECTOR\s+.*/g),A[o.INT2_VECTOR]=i(/#3DP_INT2_VECTOR\s+.*/g),A[o.INT3_VECTOR]=i(/#3DP_INT3_VECTOR\s+.*/g),A[o.INT4_VECTOR]=i(/#3DP_INT4_VECTOR\s+.*/g),A[o.MATRIX2]=i(/#3DP_MATRIX2\s+.*/g),A[o.MATRIX3]=i(/#3DP_MATRIX3\s+.*/g),A[o.MATRIX4]=i(/#3DP_MATRIX4\s+.*/g),A[o.TEXTURE]=i(/#3DP_TEXTURE\s+.*/g),A[o.VERTEX_ATTRIBUTE]=i(/#3DP_VERTEX_ATTRIBUTE\s+.*/g),A)a(parseInt(l),A[l])},this.add=function(r){if(!_3DP_Helper.checkType(r,_3DP_TYPE.SHADER))return console.log(r+" ShaderManager不支援的資料類別，使用預設資源"),e.DEFAULT;var t=e.canvas.getWebGL(),n=r.getMember().RAWDATA,o=e.compileShader(n.VERTEX_SHADER,t.VERTEX_SHADER);o||console.log(r+",vertex shader編譯錯誤");var i=e.compileShader(n.FRAGMENT_SHADER,t.FRAGMENT_SHADER);return i||console.log(r+",fragment shader編譯錯誤"),o&&i?(e.shaderInputProcess(r),r.getMember().RESOURCE.PROGRAM=e.programShader(o,i),e.getShaderLoc(r),r):(console.log("Shader編譯錯誤，使用預設資源"),e.DEFAULT)},this.remove=function(e){if(_3DP_Helper.checkType(e,_3DP_TYPE.SHADER))if(e.get3DPId()!=DEFAULTID)var r=e.getResource();else console.log(e+" 為預設資源，不可移除");else console.log(e+" ShaderManager不支援的資料類別，未移除任何資源")}}function _3DP_TextureManager(){var e={canvas:null,createBuffer:null,maintainList:{},DEFAULT:null};this.init=function(r){e.canvas=r.getCanvas(),e.DEFAULT=new _3DP_Texture;var t=new Image;t.src="data:image/jpg;base64,/9j/4AAQSkZJRgABAQEAYABgAAD/4QBeRXhpZgAATU0AKgAAAAgABFEAAAQAAAABAAAAAFEBAAMAAAABAAEAAFECAAEAAAAYAAAAPlEDAAEAAAABAAAAAAAAAAD///8AAAAPDw/w8PD09PQdHR3i4uILCwv/2wBDAAIBAQIBAQICAgICAgICAwUDAwMDAwYEBAMFBwYHBwcGBwcICQsJCAgKCAcHCg0KCgsMDAwMBwkODw0MDgsMDAz/2wBDAQICAgMDAwYDAwYMCAcIDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAz/wAARCAEAAQADASIAAhEBAxEB/8QAHwAAAQUBAQEBAQEAAAAAAAAAAAECAwQFBgcICQoL/8QAtRAAAgEDAwIEAwUFBAQAAAF9AQIDAAQRBRIhMUEGE1FhByJxFDKBkaEII0KxwRVS0fAkM2JyggkKFhcYGRolJicoKSo0NTY3ODk6Q0RFRkdISUpTVFVWV1hZWmNkZWZnaGlqc3R1dnd4eXqDhIWGh4iJipKTlJWWl5iZmqKjpKWmp6ipqrKztLW2t7i5usLDxMXGx8jJytLT1NXW19jZ2uHi4+Tl5ufo6erx8vP09fb3+Pn6/8QAHwEAAwEBAQEBAQEBAQAAAAAAAAECAwQFBgcICQoL/8QAtREAAgECBAQDBAcFBAQAAQJ3AAECAxEEBSExBhJBUQdhcRMiMoEIFEKRobHBCSMzUvAVYnLRChYkNOEl8RcYGRomJygpKjU2Nzg5OkNERUZHSElKU1RVVldYWVpjZGVmZ2hpanN0dXZ3eHl6goOEhYaHiImKkpOUlZaXmJmaoqOkpaanqKmqsrO0tba3uLm6wsPExcbHyMnK0tPU1dbX2Nna4uPk5ebn6Onq8vP09fb3+Pn6/9oADAMBAAIRAxEAPwD8A6KKKACiiigAooooAKKKKACiiigAooooAKKKKACmyU6myUAf38SU2nSU2gAooooAKKKKACiiigAooooAKKKKACiiigAooooA/gLooooAKKKKACiiigAooooAKKKKACiiigAooooAKbJTqbJQB/fxJTadJTaACiiigAooooAKKKKACiiigAooooAKKKKACiiigD+AuiiigAooooAKKKKACiiigAooooAKKKKACiiigApslOpslAH9/ElNp0lNoAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAP4C6KKKACiiigAooooAKKKKACiiigAooooAKKKKACmyU6myUAf38SU2nSU2gAooooAKKKKACiiigAooooAKKKKACiiigAooooA/gLooooAKKKKACiiigAooooAKKKKACiiigAooooAKbJTqbJQB/fxJTadJTaACiiigAooooAKKKKACiiigAooooAKKKKACiiigD+AuiiigAooooAKKKKACiiigAooooAKKKKACiiigApslOpslAH9/ElNp0lNoAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAP4C6KKKACiiigAooooAKKKKACiiigAooooAKKKKACmyU6myUAf38SU2nSU2gAooooAKKKKACiiigAooooAKKKKACiiigAooooA/gLopvmUeZQA6im+ZR5lADqKb5lHmUAOopvmUeZQA6im+ZR5lADqKb5lHmUAOopvmUeZQA6myUeZSM26gD+/mSm09l3Unl0ANop3l0eXQA2ineXR5dADaKd5dHl0ANop3l0eXQA2ineXR5dADaKd5dHl0ANop3l0eXQA3z/b9aPP8Ab9ajooAk8/2/Wjz/AG/Wo6KAJPP9v1o8/wBv1qOigCTz/b9aPP8Ab9ajooAk8/2/Wjz/AG/Wo6KAJPP9v1o8/wBv1qOigCTz/b9aPP8Ab9ajooAk8/2/WnRyb6hqSD+KgD+AeiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA/v0ooooAKKKKACiiigAooooAKKKKACiiigAooooAKkg/iqOpIP4qAP4B6KKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD+/SiiigAooooAKKKKACiiigAooooAKKKKACiiigAqSD+Ko6kg/ioA/gHooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAP79KKKKACiiigAooooAKKKKACiiigAooooAKKKKACpIP4qjqSD+KgD+AeiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA/v0ooooAKKKKACiiigAooooAKKKKACiiigAooooAKkg/iqOpIP4qAP4B6KKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD+/SiiigAooooAKKKKACiiigAooooAKKKKACiiigAqSD+Ko6kg/ioA/gHooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAP79KKKKACiiigAooooAKKKKACiiigAooooAKKKKACpIP4qjqSD+KgD+AeiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA/v0ooooAKKKKACiiigAooooAKKKKACiiigAooooAKkg/iqOpIP4qAP4B6KKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD//2Q==",e.DEFAULT.getMember().RAWDATA=t,this.add(e.DEFAULT)},e.createBuffer=function(r){var t=e.canvas.getWebGL(),n=t.createTexture();t.bindTexture(t.TEXTURE_2D,n),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!0),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,r.getMember().RAWDATA),r.getMember().RESOURCE=n,t.bindTexture(t.TEXTURE_2D,null)},this.add=function(r){return _3DP_Helper.checkType(r,_3DP_TYPE.TEXTURE)?(e.createBuffer(r),r):(console.log(r+" TextureManager不支援的資料類別，使用預設資源"),e.DEFAULT)}}function extend(e,r){e.prototype=new r,e.prototype.constructor=e}extend(_3DP_Resource,_3DP_BaseComponent),extend(_3DP_Camera,_3DP_Resource),extend(_3DP_Model,_3DP_Resource),extend(_3DP_Texture,_3DP_Resource),extend(_3DP_Shader,_3DP_Resource),extend(_3DP_RenderObject,_3DP_Resource),(_3DP_Helper={}).emptyFunction=function(){},_3DP_Helper.checkType=function(e,r){return void 0!==(e=e||{}).get3DPType&&e.get3DPType()==r},_3DP_Helper.checkId=function(e){return void 0!==(e=e||{}).get3DPId&&e.get3DPId()},_3DP_Helper.getTime=function(){return(new Date).getTime()},_3DP_Helper.createPlane=function(){var e=new _3DP_Model,r=e.getMember().RAWDATA;return r.VERTEX=[[.5,.5,0],[-.5,.5,0],[-.5,-.5,0],[.5,-.5,0]],r.INDEX=[[0,1,2],[2,3,0]],r.NORMAL=[[0,0,1],[0,0,1],[0,0,1],[0,0,1]],r.TEXTURE_COORDINATE=[[1,1],[0,1],[0,0],[1,0]],e},_3DP_Helper.criticalError=function(e){this.setTimeout=_3DP_Helper.emptyFunction,alert("嚴重錯誤 程序停止\n\n"+e)},_3DP_Helper.degToRad=function(e){return Math.PI/180*e},_3DP_Helper.multiplyM4=function(e,r){return mat4.multiply([],e,r)},_3DP_Helper.dotV3=function(e,r){return vec3.dot(e,r)},_3DP_Helper.crossV3=function(e,r){return vec3.cross([],e,r)},_3DP_Helper.normalizeV3=function(e){return vec3.normalize([],e)},_3DP_Helper.lookAt=function(e,r,t){var n=[];return mat4.lookAt(n,e,r,t),n},_3DP_Helper.perspective=function(e,r,t,n){var o=[];return mat4.perspective(o,Math.PI/180*e,r,t,n),o},_3DP_Helper.createTransformMatrix=function(){return mat4.create()},_3DP_Helper.identity=function(e){return mat4.identity(e),e},_3DP_Helper.clone=function(e){return mat4.clone(e)},_3DP_Helper.copyTo=function(e,r){mat4.copy(r,e)},_3DP_Helper.translate=function(e,r){return mat4.translate([],e,r)},_3DP_Helper.scale=function(e,r){return mat4.scale([],e,r)},_3DP_Helper.rotate=function(e,r,t){return mat4.rotate([],e,t,r)},_3DP_Helper.rotateX=function(e,r){return mat4.rotateX([],e,r)},_3DP_Helper.rotateY=function(e,r){return mat4.rotateY([],e,r)},_3DP_Helper.rotateZ=function(e,r){return mat4.rotateZ([],e,r)},_3DP_Helper.flatArray=function(e){for(var r=[],t=0;t<e.length;t++)e[t]instanceof Array?r=r.concat(_3DP_Helper.flatArray(e[t])):r.push(e[t]);return r},_3DP_Helper.calculateTengent=function(e,r,t,n,o,i,a){var A=function(e,r){for(var t=[],n=0;n<e.length;n++)t[n]=e[n]-r[n];return t},l=function(e,r){for(var t=[],n=0;n<e.length;n++)t[n]=0==r?0:e[n]/r;return t},_=function(e,r,t,n,o,i){var a=[];if(0==t&&0==i)return a=l(A(e,n),1/(r-o)),r-o==0?[0,0,0]:_3DP_Helper.normalizeV3(a);var _=l(e,i),T=l(n,t),u=r*i,c=o*t;return a=l(A(_,T),1/(u-c)),u-c==0?[0,0,0]:_3DP_Helper.normalizeV3(a)},T=A(r,e),u=A(t,e),c=A(o,n),E=A(i,n),D=c[0],s=c[1],R=E[0],P=E[1];return D==R&&s==P?[0,0,0]:D==R&&0==D?_3DP_Helper.normalizeV3(_3DP_Helper.crossV3(a,_(T,s,D,u,P,R))):_(T,D,s,u,R,P)},_3DP_Helper.rayTest=function(e,r,t,n,o,i,a){i=i||0,a=a||1e3;var A=[];A[0]=!1,A[1]=0,A[2]=0,A[3]=0,A[4]=0;for(var l=[],_=[],T=0;;){for(var u=0;u<3;u++)l[u]=n[u]-t[u],_[u]=o[u]-t[u];if(!(_3DP_Helper.dotV3(l,_)<0))break;if(T>1)return alert("Can not find angle <= 90"),A;var c=[];c=t,t=o,o=n,n=c,T++}var E=[];_3DP_Helper.crossV3(l,_,E);var D=_3DP_Helper.dotV3(E,t),s,R,P=(-1*_3DP_Helper.dotV3(E,e)+D)/_3DP_Helper.dotV3(E,r);if(P<0||P<i||P>a)return A;for(var g=[],u=0;u<3;u++)g[u]=e[u]+r[u]*P;for(var f=[],u=0,C,K,h,M,m;u<3;u++)f[u]=g[u]-t[u];if(C=Math.sqrt(Math.pow(l[0],2)+Math.pow(l[1],2)+Math.pow(l[2],2)),K=Math.sqrt(Math.pow(_[0],2)+Math.pow(_[1],2)+Math.pow(_[2],2)),(h=Math.sqrt(Math.pow(f[0],2)+Math.pow(f[1],2)+Math.pow(f[2],2)))>C&&h>K)return A;if(M=_3DP_Helper.dotV3(f,l)/C,m=_3DP_Helper.dotV3(f,_)/K,M<0||m<0)return A;if(M>C||m>K)return A;_3DP_Helper.normalizeV3(l),_3DP_Helper.normalizeV3(_),_3DP_Helper.normalizeV3(f);var d=_3DP_Helper.dotV3(l,_);return _3DP_Helper.dotV3(f,l)<d||_3DP_Helper.dotV3(f,_)<d?A:M/C+m/K>2?A:(A[0]=!0,A[1]=g[0],A[2]=g[1],A[3]=g[2],A[4]=P,A)},extend(_3DP_CameraManager,_3DP_BaseComponent),extend(_3DP_CanvasController,_3DP_BaseComponent),extend(_3DP_FileLoader,_3DP_BaseComponent),extend(_3DP_FrameController,_3DP_BaseComponent),extend(_3DP_ModelManager,_3DP_BaseComponent),extend(_3DP_RenderController,_3DP_BaseComponent),extend(_3DP_ResourceManager,_3DP_BaseComponent),extend(_3DP_SceneManager,_3DP_BaseComponent),extend(_3DP_ShaderManager,_3DP_BaseComponent),extend(_3DP_TextureManager,_3DP_BaseComponent),this.setTimeout=setTimeout||window.setTimeout,this.Math=Math,this.console.log=console.log,this.alert=alert,this.FloatArray=Float32Array,this.IntArray=Int32Array,this.UintArray=Uint16Array;var _3DP_TYPE={CANVAS:null,MODEL:null,TEXTURE:null,SHADER:null,CAMERA:null,RENDER_OBJECT:null},enumCount=1;for(var i in _3DP_TYPE)_3DP_TYPE[i]=enumCount,enumCount++;var _3DP_SHADER_INPUT={FLOAT:0,FLOAT2:1,FLOAT3:2,FLOAT4:3,FLOAT_VECTOR:4,FLOAT2_VECTOR:5,FLOAT3_VECTOR:6,FLOAT4_VECTOR:7,INT:8,INT2:9,INT3:10,INT4:11,INT_VECTOR:12,INT2_VECTOR:13,INT3_VECTOR:14,INT4_VECTOR:15,MATRIX2:16,MATRIX3:17,MATRIX4:18,TEXTURE:19,VERTEX_ATTRIBUTE:20},_3DP_GLOBAL_ID=0,setId=function(){return _3DP_GLOBAL_ID+=1},_3DP_Helper;function _3DP_BaseComponent(){this._3DP_ID=null,this._3DP_TYPE=null,this.init=function(){}}function _3DP_Canvas(e){var r={ID:setId(),TYPE:_3DP_TYPE.CANVAS,RAWDATA:null,RESOURCE:null};this.init=function(){this._3DP_ID=r.ID,this._3DP_TYPE=r.TYPE},this.get3DPId=function(){return r.ID},this.get3DPType=function(){return r.TYPE},this.getCanvas=function(){return r.RAWDATA},this.getWebGL=function(){return r.RESOURCE},this.getMember=function(){return r},this.init()}function _3DP_Resource(){this.isUsing=!1,this.countUse=0}function _3DP_Camera(){var e={ID:setId(),TYPE:_3DP_TYPE.CAMERA};this.init=function(){this._3DP_ID=e.ID,this._3DP_TYPE=e.TYPE},this.get3DPId=function(){return e.ID},this.get3DPType=function(){return e.TYPE},this.getMember=function(){return e},this.getViewMatrix=function(){return _3DP_Helper.lookAt(this.position,this.lookAt,this.up)},this.getProjectionMatrix=function(e){return e=e||1,_3DP_Helper.perspective(this.viewAngle,e,this.neapPlane,this.farPlane)},this.position=[0,0,10],this.up=[0,1,0],this.lookAt=[0,0,0],this.viewAngle=45,this.neapPlane=.001,this.farPlane=1e3,this.viewportStartX=0,this.viewportStartY=0,this.viewportEndX=null,this.viewportEndY=null,this.active=!0,this.init()}function _3DP_Model(){var e={ID:setId(),TYPE:_3DP_TYPE.MODEL,RAWDATA:{VERTEX:[],NORMAL:[],TEXTURE_COORDINATE:[],INDEX:[],EXTRA:{}},RESOURCE:{VERTEX:null,NORMAL:null,TEXTURE_COORDINATE:null,INDEX:null,EXTRA:{}}};this.init=function(){this._3DP_ID=e.ID,this._3DP_TYPE=e.TYPE},this.get3DPId=function(){return e.ID},this.get3DPType=function(){return e.TYPE},this.getMember=function(){return e},this.getModelRawData=function(){return e.RAWDATA},this.setExtraData=function(r,t){t.length==e.RAWDATA.VERTEX.length?e.RAWDATA.EXTRA[r]=t:console.log("Vertex額外資料數量必須與vertex數量相同，未設定任何資料")},this.getExtraData=function(r){return e.RESOURCE.EXTRA[r]},this.init()}function _3DP_Texture(){var e={ID:setId(),TYPE:_3DP_TYPE.TEXTURE,RAWDATA:null,RESOURCE:null};this.init=function(){this._3DP_ID=e.ID,this._3DP_TYPE=e.TYPE},this.get3DPId=function(){return e.ID},this.get3DPType=function(){return e.TYPE},this.getMember=function(){return e},this.init()}function _3DP_Shader(){var e={ID:setId(),TYPE:_3DP_TYPE.SHADER,RAWDATA:{VERTEX_SHADER:null,FRAGMENT_SHADER:null,SHADER_INPUT:{}},RESOURCE:{PROGRAM:null,LOC:{VERTEX:-1,NORMAL:-1,TEXTURE_COORDINATE:-1,TRANSFORM_MATRIX:null,VIEW_MATRIX:null,PROJECTION_MATRIX:null,SHADER_INPUT:{}}}};this.init=function(){this._3DP_ID=e.ID,this._3DP_TYPE=e.TYPE},this.get3DPId=function(){return e.ID},this.get3DPType=function(){return e.TYPE},this.getMember=function(){return e},this.init()}function _3DP_RenderObject(){var e={ID:setId(),TYPE:_3DP_TYPE.RENDER_OBJECT,ELEMENT:{MODEL:null,SHADER:null,SHADER_INPUT:{},TRANSFORM_MATRIX:[]}};this.init=function(){this._3DP_ID=e.ID,this._3DP_TYPE=e.TYPE,e.ELEMENT.TRANSFORM_MATRIX=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]},this.get3DPId=function(){return e.ID},this.get3DPType=function(){return e.TYPE},this.getMember=function(){return e},this.setTransformMatrix=function(r){e.ELEMENT.TRANSFORM_MATRIX=r},this.getTransformMatrix=function(){return e.ELEMENT.TRANSFORM_MATRIX},this.setModel=function(r){_3DP_Helper.checkType(r,_3DP_TYPE.MODEL)?e.ELEMENT.MODEL=r:console.log(r+" 不是Model，使用預設Model")},this.setShader=function(r){_3DP_Helper.checkType(r,_3DP_TYPE.SHADER)?e.ELEMENT.SHADER=r:console.log(r+" 不是Shader，使用預設Shader")},this.setShaderInput=function(r,t){e.ELEMENT.SHADER_INPUT[r]={},e.ELEMENT.SHADER_INPUT[r].DATA=t},this.clearShaderInput=function(){e.ELEMENT.SHADER_INPUT={}},this.active=!0,this.init()}function wizard(e){var r={cameraManager:null,canvasController:null,fileLoader:null,frameController:null,modelManager:null,renderController:null,resourceManager:null,sceneManager:null,shaderManager:null,textureManager:null};r.canvasController=new _3DP_CanvasController,r.canvasController.init(e),r.renderController=new _3DP_RenderController,r.renderController.init(r.canvasController),r.cameraManager=new _3DP_CameraManager,r.cameraManager.init(),r.fileLoader=new _3DP_FileLoader,r.fileLoader.init(),r.frameController=new _3DP_FrameController,r.frameController.init(r.renderController),r.modelManager=new _3DP_ModelManager,r.modelManager.init(r.canvasController),r.resourceManager=new _3DP_ResourceManager,r.resourceManager.init(),r.sceneManager=new _3DP_SceneManager,r.sceneManager.init(),r.shaderManager=new _3DP_ShaderManager,r.shaderManager.init(r.canvasController),r.textureManager=new _3DP_TextureManager,r.textureManager.init(r.canvasController),this.getCameraManager=function(){return r.cameraManager},this.getCanvasController=function(){return r.canvasController},this.getFileLoader=function(){return r.fileLoader},this.getFrameController=function(){return r.frameController},this.getModelManager=function(){return r.modelManager},this.getRenderController=function(){return r.renderController},this.getResourceManager=function(){return r.resourceManager},this.getSceneManager=function(){return r.sceneManager},this.getShaderManager=function(){return r.shaderManager},this.getTextureManager=function(){return r.textureManager}}function _3DP_CameraManager(){var e={maintainList:{},cameraList:[]};this.add=function(r){e.maintainList[r._3DP_ID]=r,e.cameraList.push(r)},this.remove=function(r){delete e.maintainList[r._3DP_ID]},this.refreshCameraList=function(){var r=e.cameraList,t=e.maintainList;for(var n in r=[],t)r.push(t[n])},this.sortCameraList=function(){},this.getCameraList=function(){return e.cameraList}}function _3DP_CanvasController(){var e={canvas:null};this.init=function(r){for(var t=["webgl","webkit-3d","moz-webgl","experimental-webgl"],n=!1,o=0;o<4;o++){try{var n=r.getContext(t[o])}catch(e){console.log(e),n=!1}if(n)break}if(!n)return _3DP_Helper.criticalError("此瀏覽器不支援WebGL，請改用有支援的瀏覽器。如Chrome"),!1;var i=new _3DP_Canvas;i.getMember().RAWDATA=r,i.getMember().RESOURCE=n,e.canvas=i},this.getCanvas=function(){return e.canvas}}function _3DP_FileLoader(){var e={callBack:null};this.init=function(){e.callBack=function(e,r){console.log("未設置callback function, 格式為fun(_result, _argArray)")}},this.loadObjModel=async function(r,t,n){t=t||e.callBack;let o=await fetch(r),i;for(var a=await o.text(),A=[],l=[],_=[],T=[],u=/v\s.*/g,c=/vt\s.*/g,E=/vn\s.*/g,D=/f\s.*/g,s=a.match(u),R=a.match(c),P=a.match(E),g=a.match(D),f=0;f<s.length;f++){var C=s[f].match(/[-.0-9]+/g);s[f]=[1*C[0],1*C[1],1*C[2]]}for(var f=0;f<R.length;f++){var C=R[f].match(/[-.0-9]+/g);R[f]=[1*C[0],1*C[1]]}for(var f=0;f<P.length;f++){var C=P[f].match(/[-.0-9]+/g);P[f]=[1*C[0],1*C[1],1*C[2]]}for(var f=0;f<g.length;f++){for(var C,K=(C=g[f].match(/[\/0-9]+/g)).length,h=0;h<K;h++){var M=C[h].split("/");A.push(s[1*M[0]-1]),R.length>0?l.push(R[1*M[1]-1]):l.push([0,0]),P.length>0?_.push(P[1*M[2]-1]):_.push([0,0,0])}for(var m=A.length,d=K-2,h=0;h<d;h++){var O=m-K;T.push([O,O+h+1,O+h+2])}}var I=new _3DP_Model,v=I.getMember().RAWDATA;v.VERTEX=A,v.TEXTURE_COORDINATE=l,v.NORMAL=_,v.INDEX=T,t(I,n=n||[])},this.loadShader=async function(r,t,n,o){n=n||e.callBack;var i=new _3DP_Shader,a=i.getMember().RAWDATA;let A=await fetch(r),l=await fetch(t);a.VERTEX_SHADER=await A.text(),a.FRAGMENT_SHADER=await l.text(),n(i,o=o||[])},this.loadTexture=function(r,t,n){t=t||e.callBack;var o=new Image;o.onload=function(){var e=new _3DP_Texture;e.getMember().RAWDATA=o,t(e,n=n||[])},o.src=r},this.init()}function _3DP_FrameController(){var e={renderController:null,frameFun:_3DP_Helper.emptyFunction,timeoutFun:null,frameStartTime:0,everFrameWaitTime:33,isPlay:!1,calculateFPSFun:null,isCalculateFPS:!1,FPS:0,countFPS:0,preFPSTime:0};this.init=function(r){e.renderController=r},this.setFPS=function(r){e.everFrameWaitTime=r<=0?1e3:Math.round(1e3/r)},e.calculateFPSFun=function(){e.countFPS++;var r=e.countFPS,t=_3DP_Helper.getTime()-e.preFPSTime;t>=1e3&&(e.preFPSTime=_3DP_Helper.getTime(),e.countFPS=0),t<=0&&(t=1),e.FPS=Math.round(r/t*1e5)/100},this.FPS=function(){return e.FPS},this.calculateFPS=function(r){r?e.isCalculateFPS=!0:(e.isCalculateFPS=!1,e.FPS=0,e.countFPS=0)},this.setFrameFunction=function(r){e.frameFun=r},e.timeoutFun=function(){var r=e.renderController;if(0!=e.isPlay&&null!=r){e.frameStartTime=_3DP_Helper.getTime(),e.frameFun(),r.renderAll(),r.waitComplete(),e.isCalculateFPS&&e.calculateFPSFun();var t=e.everFrameWaitTime-(_3DP_Helper.getTime()-e.frameStartTime);setTimeout(e.timeoutFun,t)}else null==r&&_3DP_Helper.criticalError("_3DP_FrameController未完成初始化，_3DP_FrameController.init(instance _3DP_RenderController)")},this.start=function(){e.isPlay=!0,e.timeoutFun()},this.stop=function(){e.isPlay=!1}}function _3DP_ModelManager(){var e={canvas:null,DEFAULT:null,createBuffer:null};this.init=function(r){e.canvas=r.getCanvas();var t=_3DP_Helper.createPlane();e.DEFAULT=this.add(t)},e.createBuffer=function(r,t,n){n=n||!1;var o=e.canvas.getWebGL(),i=o.createBuffer(),a=_3DP_Helper.flatArray(r);return n?(o.bindBuffer(o.ELEMENT_ARRAY_BUFFER,i),o.bufferData(o.ELEMENT_ARRAY_BUFFER,new t(a),o.STATIC_DRAW),i.SIZE=a.length,i):(o.bindBuffer(o.ARRAY_BUFFER,i),o.bufferData(o.ARRAY_BUFFER,new t(a),o.STATIC_DRAW),i.SIZE=r[0].length,i)},this.add=function(r){if(!_3DP_Helper.checkType(r,_3DP_TYPE.MODEL))return console.log(r+" ,ModelManager不支援的資料類別，使用預設資源"),e.DEFAULT;var t=r.getMember().RESOURCE,n=r.getMember().RAWDATA;if(null==n.VERTEX||null==n.INDEX)return console.log(r+" ,Model資料不完整，使用預設資源"),e.DEFAULT;for(var o in t.VERTEX=e.createBuffer(n.VERTEX,FloatArray),t.INDEX=e.createBuffer(n.INDEX,UintArray,!0),null!=n.NORMAL&&(t.NORMAL=e.createBuffer(n.NORMAL,FloatArray)),null!=n.TEXTURE_COORDINATE&&(t.TEXTURE_COORDINATE=e.createBuffer(n.TEXTURE_COORDINATE,FloatArray)),n.EXTRA)t.EXTRA[o]=e.createBuffer(n.EXTRA[o],FloatArray);return r},this.remove=function(e){if(_3DP_Helper.checkType(e,_3DP_TYPE.MODEL))var r=e.getResource();else console.log(e+" ,ModelManager不支援的資料類別，未移除任何資源")}}function _3DP_RenderController(){var e={canvas:null,draw:null,renderPreProcess:null,shaderInput:null,textureUnitArray:[],renderList:[],cameraList:[],randerTarget:null,cameraCheck:!0,renderObjectCheck:!0};this.init=function(r){e.canvas=r.getCanvas();var t=e.canvas.getWebGL();t.enable(t.DEPTH_TEST),t.frontFace(t.CCW),t.disable(t.CULL_FACE),t.cullFace(t.BACK);for(var n=0;n<t.getParameter(t.MAX_COMBINED_TEXTURE_IMAGE_UNITS);n++)e.textureUnitArray.push(t.TEXTURE0+n);this.setClearFrame(!0,!0,!1)},this.setRenderObjectList=function(r){r instanceof Array?e.renderList=r:console.log("RenderController.setRenderObjectList(array of instance _3DP_RenderObject)錯誤，輸入為Array資料類別，未輸入任何資料")},this.setCameraList=function(r){r instanceof Array?e.cameraList=r:console.log("RenderController.setCameraList(array of instance _3DP_Camera)錯誤，輸入為Array資料類別，未輸入任何資料")},e.shaderInput=function(r){var t=e.canvas.getWebGL(),n=r.SHADER.getMember().RESOURCE.LOC.SHADER_INPUT,o=r.SHADER_INPUT,i=_3DP_SHADER_INPUT,a=0;for(var A in n)if(null!=o[A])switch(n[A].TYPE){case i.FLOAT:t.uniform1f(n[A].LOC,o[A].DATA);break;case i.FLOAT2:t.uniform2f(n[A].LOC,o[A].DATA[0],o[A].DATA[1]);break;case i.FLOAT3:t.uniform3f(n[A].LOC,o[A].DATA[0],o[A].DATA[1],o[A].DATA[2]);break;case i.FLOAT4:t.uniform4f(n[A].LOC,o[A].DATA[0],o[A].DATA[1],o[A].DATA[2],o[A].DATA[3]);break;case i.FLOAT_VECTOR:t.uniform1fv(n[A].LOC,_3DP_Helper.flatArray(o[A].DATA));break;case i.FLOAT2_VECTOR:t.uniform2fv(n[A].LOC,_3DP_Helper.flatArray(o[A].DATA));break;case i.FLOAT3_VECTOR:t.uniform3fv(n[A].LOC,_3DP_Helper.flatArray(o[A].DATA));break;case i.FLOAT4_VECTOR:t.uniform4fv(n[A].LOC,_3DP_Helper.flatArray(o[A].DATA));break;case i.INT:t.uniform1i(n[A].LOC,o[A].DATA);break;case i.INT2:t.uniform2i(n[A].LOC,o[A].DATA[0],o[A].DATA[1]);break;case i.INT3:t.uniform3i(n[A].LOC,o[A].DATA[0],o[A].DATA[1],o[A].DATA[2]);break;case i.INT4:t.uniform4i(n[A].LOC,o[A].DATA[0],o[A].DATA[1],o[A].DATA[2],o[A].DATA[3]);break;case i.INT_VECTOR:t.uniform1iv(n[A].LOC,_3DP_Helper.flatArray(o[A].DATA));break;case i.INT2_VECTOR:t.uniform2iv(n[A].LOC,_3DP_Helper.flatArray(o[A].DATA));break;case i.INT3_VECTOR:t.uniform3iv(n[A].LOC,_3DP_Helper.flatArray(o[A].DATA));break;case i.INT4_VECTOR:t.uniform4iv(n[A].LOC,_3DP_Helper.flatArray(o[A].DATA));break;case i.MATRIX2:t.uniformMatrix2fv(n[A].LOC,_3DP_Helper.flatArray(o[A].DATA));break;case i.MATRIX3:t.uniformMatrix3fv(n[A].LOC,_3DP_Helper.flatArray(o[A].DATA));break;case i.MATRIX4:t.uniformMatrix4fv(n[A].LOC,_3DP_Helper.flatArray(o[A].DATA));break;case i.TEXTURE:var l=e.textureUnitArray;if(a>=l.length){console.log("Texture最多只能"+l.length+"張");break}t.activeTexture(l[a]),t.bindTexture(t.TEXTURE_2D,o[A].DATA.getMember().RESOURCE),t.uniform1i(n[A].LOC,a),a+=1;break;case i.VERTEX_ATTRIBUTE:var _=r.MODEL.getMember().RESOURCE.EXTRA[A];n[A].LOC>-1&&null!=_&&(t.bindBuffer(t.ARRAY_BUFFER,_),t.vertexAttribPointer(n[A].LOC,_.SIZE,t.FLOAT,!1,0,0))}},e.draw=function(r,t,n){var o=e.canvas.getWebGL(),i=r.MODEL.getMember().RESOURCE,a=i.VERTEX,A=i.INDEX,l=i.NORMAL,_=i.TEXTURE_COORDINATE,T=r.SHADER.getMember().RESOURCE.LOC;o.useProgram(r.SHADER.getMember().RESOURCE.PROGRAM),o.bindBuffer(o.ARRAY_BUFFER,a),o.vertexAttribPointer(T.VERTEX,a.SIZE,o.FLOAT,!1,0,0),T.NORMAL>-1&&null!=l&&(o.bindBuffer(o.ARRAY_BUFFER,l),o.vertexAttribPointer(T.NORMAL,l.SIZE,o.FLOAT,!1,0,0)),T.TEXTURE_COORDINATE>-1&&null!=_&&(o.bindBuffer(o.ARRAY_BUFFER,_),o.vertexAttribPointer(T.TEXTURE_COORDINATE,_.SIZE,o.FLOAT,!1,0,0)),o.uniformMatrix4fv(T.TRANSFORM_MATRIX,!1,r.TRANSFORM_MATRIX),o.uniformMatrix4fv(T.VIEW_MATRIX,!1,t),o.uniformMatrix4fv(T.PROJECTION_MATRIX,!1,n),o.bindBuffer(o.ELEMENT_ARRAY_BUFFER,A),e.shaderInput(r),o.drawElements(o.TRIANGLES,A.SIZE,o.UNSIGNED_SHORT,0)},e.renderPreProcess=function(r,t){for(var n=e.renderList,o=n.length,i=0;i<o;i++)if(0!=n[i].active){var a=n[i].getMember().ELEMENT;if(o<=0)return void(e.renderObjectCheck&&(console.log("RenderController未設置任何RenderObject，RenderController.setRenderObjectList(array of instance _3DP_RenderObject)"),e.renderObjectCheck=!1));null!=a.MODEL&&null!=a.SHADER?e.draw(a,r,t):(console.log(n[i]+"Render Object資料不完整, 停止處理此物件"),n[i].active=!1)}},this.renderAll=function(){var r=e.cameraList,t=e.cameraList.length,n=e.renderPreProcess;if(t<=0)e.cameraCheck&&(console.log("RenderController未設置任何攝影機，RenderController.setCameraList(array of instance _3DP_Camera)"),e.cameraCheck=!1);else for(var o=e.canvas.getWebGL(),i=0;i<t;i++){var a=r[i].viewportStartX,A=r[i].viewportEndX,l=r[i].viewportStartY,_=r[i].viewportEndY;null==A&&(r[i].viewportEndX=e.canvas.getCanvas().width),null==_&&(r[i].viewportEndY=e.canvas.getCanvas().height),o.viewport(a,l,A,_),n(r[i].getViewMatrix(),r[i].getProjectionMatrix(Math.abs((A-a)/(_-l))))}},this.waitComplete=function(){},this.setClearFrame=function(r,t,n){var o=e.canvas.getWebGL();r&&o.clear(o.COLOR_BUFFER_BIT),t&&o.clear(o.DEPTH_BUFFER_BIT),n&&o.clear(o.STENCIL_BUFFER_BIT)},this.setRanderTarget=function(r){e.randerTarget=r},this.getRanderTarget=function(){return e.randerTarget},this.assignRanderTarget=function(){var r=e.canvas.getWebGL();r.bindFramebuffer(r.FRAMEBUFFER,e.randerTarget)}}function _3DP_ResourceManager(){this.init=function(){},this.remove=function(e){}}function _3DP_SceneManager(){var e={maintainList:{},renderObjectList:[]};this.add=function(r){_3DP_Helper.checkType(r,_3DP_TYPE.RENDER_OBJECT)?(e.maintainList[r.get3DPId()]=r,e.renderObjectList.push(r)):console.log(r+" SceneManager不支援的資料類別，未加入任何資源")},this.remove=function(r){delete e.maintainList[r.get3DPId()]},this.clear=function(){e.renderObjectList=[]},this.refreshRenderObjectList=function(){var r=e.renderObjectList,t=e.maintainList;for(var n in r=[],t)r.push(t[n])},this.sortRenderObjectList=function(){},this.getRenderObjectList=function(){return e.renderObjectList}}function _3DP_ShaderManager(){var e={canvas:null,DEFAULT:null,compileShader:null,programShader:null,getShaderLoc:null,shaderInputProcess:null,defaultVS:null,defaultFS:null,defaultVS:function(){var e;return"attribute vec3 aVertex;uniform mat4 uTransformMatrix;uniform mat4 uViewMatrix;uniform mat4 uProjectionMatrix;void main(void) {gl_Position = uProjectionMatrix * uViewMatrix * uTransformMatrix * vec4(aVertex, 1.0);}"},defaultFS:function(){var e;return"void main(void) {gl_FragColor = vec4(1.0, 0.0, 1.0, 1.0);}"}};this.init=function(r){e.canvas=r.getCanvas();var t=new _3DP_Shader,n=t.getMember().RAWDATA;n.VERTEX_SHADER=e.defaultVS(),n.FRAGMENT_SHADER=e.defaultFS(),e.DEFAULT=this.add(t)},e.compileShader=function(r,t){var n=e.canvas.getWebGL(),o=n.createShader(t);return n.shaderSource(o,r),n.compileShader(o),n.getShaderParameter(o,n.COMPILE_STATUS)?o:(console.log(n.getShaderInfoLog(o)),!1)},e.programShader=function(r,t){var n=e.canvas.getWebGL(),o=n.createProgram();return n.attachShader(o,r),n.attachShader(o,t),n.linkProgram(o),n.detachShader(o,r),n.detachShader(o,t),o},e.getShaderLoc=function(r){var t=e.canvas.getWebGL(),n=r.getMember().RESOURCE.PROGRAM,o=r.getMember().RESOURCE.LOC;if(o.VERTEX=t.getAttribLocation(n,"aVertex"),o.VERTEX<0)return console.log(r+" ,Shader沒有 aVertex 變數，此為必要變數，使用預設資源"),void(r=e.DEFAULT);if(o.NORMAL=t.getAttribLocation(n,"aNormal"),o.TEXTURE_COORDINATE=t.getAttribLocation(n,"aTextureCoordinate"),o.VERTEX>-1&&t.enableVertexAttribArray(o.VERTEX),o.NORMAL>-1&&t.enableVertexAttribArray(o.NORMAL),o.TEXTURE_COORDINATE>-1&&t.enableVertexAttribArray(o.TEXTURE_COORDINATE),o.TRANSFORM_MATRIX=t.getUniformLocation(n,"uTransformMatrix"),null==o.TRANSFORM_MATRIX)return console.log(r+" ,Shader沒有 uTransformMatrix 變數，此為必要變數，使用預設資源"),void(r=e.DEFAULT);if(o.VIEW_MATRIX=t.getUniformLocation(n,"uViewMatrix"),null==o.VIEW_MATRIX)return console.log(r+" ,Shader沒有 uViewMatrix 變數，此為必要變數，使用預設資源"),void(r=e.DEFAULT);if(o.PROJECTION_MATRIX=t.getUniformLocation(n,"uProjectionMatrix"),null==o.PROJECTION_MATRIX)return console.log(r+" ,Shader沒有 uProjectionMatrix 變數，此為必要變數，使用預設資源"),void(r=e.DEFAULT);var i=r.getMember().RAWDATA.SHADER_INPUT,a=r.getMember().RESOURCE.LOC.SHADER_INPUT,A=_3DP_SHADER_INPUT;for(var l in i)a[l]={},a[l].TYPE=i[l].TYPE,a[l].TYPE==A.VERTEX_ATTRIBUTE?(a[l].LOC=t.getAttribLocation(n,l),a[l].LOC>-1&&t.enableVertexAttribArray(a[l].LOC)):a[l].LOC=t.getUniformLocation(n,l)},e.shaderInputProcess=function(e){var r=e.getMember().RAWDATA.VERTEX_SHADER,t=e.getMember().RAWDATA.FRAGMENT_SHADER,n=e.getMember().RAWDATA.SHADER_INPUT,o=_3DP_SHADER_INPUT,i=function(e){return(r.match(e)||[]).concat(t.match(e)||[])},a=function(e,r){for(var t=[],o=0;o<r.length;o++){var i=r[o].match(/[0-9a-zA-Z_]+/g)||[];i.shift(),t=t.concat(i)}for(var o=0;o<t.length;o++)n[t[o]]={},n[t[o]].TYPE=e},A={};for(var l in A[o.FLOAT]=i(/#3DP_FLOAT\s+.*/g),A[o.FLOAT2]=i(/#3DP_FLOAT2\s+.*/g),A[o.FLOAT3]=i(/#3DP_FLOAT3\s+.*/g),A[o.FLOAT4]=i(/#3DP_FLOAT4\s+.*/g),A[o.FLOAT_VECTOR]=i(/#3DP_FLOAT_VECTOR\s+.*/g),A[o.FLOAT2_VECTOR]=i(/#3DP_FLOAT2_VECTOR\s+.*/g),A[o.FLOAT3_VECTOR]=i(/#3DP_FLOAT3_VECTOR\s+.*/g),A[o.FLOAT4_VECTOR]=i(/#3DP_FLOAT4_VECTOR\s+.*/g),A[o.INT]=i(/#3DP_INT\s+.*/g),A[o.INT2]=i(/#3DP_INT2\s+.*/g),A[o.INT3]=i(/#3DP_INT3\s+.*/g),A[o.INT4]=i(/#3DP_INT4\s+.*/g),A[o.INT_VECTOR]=i(/#3DP_INT_VECTOR\s+.*/g),A[o.INT2_VECTOR]=i(/#3DP_INT2_VECTOR\s+.*/g),A[o.INT3_VECTOR]=i(/#3DP_INT3_VECTOR\s+.*/g),A[o.INT4_VECTOR]=i(/#3DP_INT4_VECTOR\s+.*/g),A[o.MATRIX2]=i(/#3DP_MATRIX2\s+.*/g),A[o.MATRIX3]=i(/#3DP_MATRIX3\s+.*/g),A[o.MATRIX4]=i(/#3DP_MATRIX4\s+.*/g),A[o.TEXTURE]=i(/#3DP_TEXTURE\s+.*/g),A[o.VERTEX_ATTRIBUTE]=i(/#3DP_VERTEX_ATTRIBUTE\s+.*/g),A)a(parseInt(l),A[l])},this.add=function(r){if(!_3DP_Helper.checkType(r,_3DP_TYPE.SHADER))return console.log(r+" ShaderManager不支援的資料類別，使用預設資源"),e.DEFAULT;var t=e.canvas.getWebGL(),n=r.getMember().RAWDATA,o=e.compileShader(n.VERTEX_SHADER,t.VERTEX_SHADER);o||console.log(r+",vertex shader編譯錯誤");var i=e.compileShader(n.FRAGMENT_SHADER,t.FRAGMENT_SHADER);return i||console.log(r+",fragment shader編譯錯誤"),o&&i?(e.shaderInputProcess(r),r.getMember().RESOURCE.PROGRAM=e.programShader(o,i),e.getShaderLoc(r),r):(console.log("Shader編譯錯誤，使用預設資源"),e.DEFAULT)},this.remove=function(e){if(_3DP_Helper.checkType(e,_3DP_TYPE.SHADER))if(e.get3DPId()!=DEFAULTID)var r=e.getResource();else console.log(e+" 為預設資源，不可移除");else console.log(e+" ShaderManager不支援的資料類別，未移除任何資源")}}function _3DP_TextureManager(){var e={canvas:null,createBuffer:null,maintainList:{},DEFAULT:null};this.init=function(r){e.canvas=r.getCanvas(),e.DEFAULT=new _3DP_Texture;var t=new Image;t.src="data:image/jpg;base64,/9j/4AAQSkZJRgABAQEAYABgAAD/4QBeRXhpZgAATU0AKgAAAAgABFEAAAQAAAABAAAAAFEBAAMAAAABAAEAAFECAAEAAAAYAAAAPlEDAAEAAAABAAAAAAAAAAD///8AAAAPDw/w8PD09PQdHR3i4uILCwv/2wBDAAIBAQIBAQICAgICAgICAwUDAwMDAwYEBAMFBwYHBwcGBwcICQsJCAgKCAcHCg0KCgsMDAwMBwkODw0MDgsMDAz/2wBDAQICAgMDAwYDAwYMCAcIDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAz/wAARCAEAAQADASIAAhEBAxEB/8QAHwAAAQUBAQEBAQEAAAAAAAAAAAECAwQFBgcICQoL/8QAtRAAAgEDAwIEAwUFBAQAAAF9AQIDAAQRBRIhMUEGE1FhByJxFDKBkaEII0KxwRVS0fAkM2JyggkKFhcYGRolJicoKSo0NTY3ODk6Q0RFRkdISUpTVFVWV1hZWmNkZWZnaGlqc3R1dnd4eXqDhIWGh4iJipKTlJWWl5iZmqKjpKWmp6ipqrKztLW2t7i5usLDxMXGx8jJytLT1NXW19jZ2uHi4+Tl5ufo6erx8vP09fb3+Pn6/8QAHwEAAwEBAQEBAQEBAQAAAAAAAAECAwQFBgcICQoL/8QAtREAAgECBAQDBAcFBAQAAQJ3AAECAxEEBSExBhJBUQdhcRMiMoEIFEKRobHBCSMzUvAVYnLRChYkNOEl8RcYGRomJygpKjU2Nzg5OkNERUZHSElKU1RVVldYWVpjZGVmZ2hpanN0dXZ3eHl6goOEhYaHiImKkpOUlZaXmJmaoqOkpaanqKmqsrO0tba3uLm6wsPExcbHyMnK0tPU1dbX2Nna4uPk5ebn6Onq8vP09fb3+Pn6/9oADAMBAAIRAxEAPwD8A6KKKACiiigAooooAKKKKACiiigAooooAKKKKACmyU6myUAf38SU2nSU2gAooooAKKKKACiiigAooooAKKKKACiiigAooooA/gLooooAKKKKACiiigAooooAKKKKACiiigAooooAKbJTqbJQB/fxJTadJTaACiiigAooooAKKKKACiiigAooooAKKKKACiiigD+AuiiigAooooAKKKKACiiigAooooAKKKKACiiigApslOpslAH9/ElNp0lNoAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAP4C6KKKACiiigAooooAKKKKACiiigAooooAKKKKACmyU6myUAf38SU2nSU2gAooooAKKKKACiiigAooooAKKKKACiiigAooooA/gLooooAKKKKACiiigAooooAKKKKACiiigAooooAKbJTqbJQB/fxJTadJTaACiiigAooooAKKKKACiiigAooooAKKKKACiiigD+AuiiigAooooAKKKKACiiigAooooAKKKKACiiigApslOpslAH9/ElNp0lNoAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAP4C6KKKACiiigAooooAKKKKACiiigAooooAKKKKACmyU6myUAf38SU2nSU2gAooooAKKKKACiiigAooooAKKKKACiiigAooooA/gLopvmUeZQA6im+ZR5lADqKb5lHmUAOopvmUeZQA6im+ZR5lADqKb5lHmUAOopvmUeZQA6myUeZSM26gD+/mSm09l3Unl0ANop3l0eXQA2ineXR5dADaKd5dHl0ANop3l0eXQA2ineXR5dADaKd5dHl0ANop3l0eXQA3z/b9aPP8Ab9ajooAk8/2/Wjz/AG/Wo6KAJPP9v1o8/wBv1qOigCTz/b9aPP8Ab9ajooAk8/2/Wjz/AG/Wo6KAJPP9v1o8/wBv1qOigCTz/b9aPP8Ab9ajooAk8/2/WnRyb6hqSD+KgD+AeiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA/v0ooooAKKKKACiiigAooooAKKKKACiiigAooooAKkg/iqOpIP4qAP4B6KKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD+/SiiigAooooAKKKKACiiigAooooAKKKKACiiigAqSD+Ko6kg/ioA/gHooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAP79KKKKACiiigAooooAKKKKACiiigAooooAKKKKACpIP4qjqSD+KgD+AeiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA/v0ooooAKKKKACiiigAooooAKKKKACiiigAooooAKkg/iqOpIP4qAP4B6KKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD+/SiiigAooooAKKKKACiiigAooooAKKKKACiiigAqSD+Ko6kg/ioA/gHooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAP79KKKKACiiigAooooAKKKKACiiigAooooAKKKKACpIP4qjqSD+KgD+AeiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA/v0ooooAKKKKACiiigAooooAKKKKACiiigAooooAKkg/iqOpIP4qAP4B6KKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD//2Q==",e.DEFAULT.getMember().RAWDATA=t,this.add(e.DEFAULT)},e.createBuffer=function(r){var t=e.canvas.getWebGL(),n=t.createTexture();t.bindTexture(t.TEXTURE_2D,n),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!0),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,r.getMember().RAWDATA),r.getMember().RESOURCE=n,t.bindTexture(t.TEXTURE_2D,null)},this.add=function(r){return _3DP_Helper.checkType(r,_3DP_TYPE.TEXTURE)?(e.createBuffer(r),r):(console.log(r+" TextureManager不支援的資料類別，使用預設資源"),e.DEFAULT)}}function extend(e,r){e.prototype=new r,e.prototype.constructor=e}extend(_3DP_Resource,_3DP_BaseComponent),extend(_3DP_Camera,_3DP_Resource),extend(_3DP_Model,_3DP_Resource),extend(_3DP_Texture,_3DP_Resource),extend(_3DP_Shader,_3DP_Resource),extend(_3DP_RenderObject,_3DP_Resource),(_3DP_Helper={}).emptyFunction=function(){},_3DP_Helper.checkType=function(e,r){return void 0!==(e=e||{}).get3DPType&&e.get3DPType()==r},_3DP_Helper.checkId=function(e){return void 0!==(e=e||{}).get3DPId&&e.get3DPId()},_3DP_Helper.getTime=function(){return(new Date).getTime()},_3DP_Helper.createPlane=function(){var e=new _3DP_Model,r=e.getMember().RAWDATA;return r.VERTEX=[[.5,.5,0],[-.5,.5,0],[-.5,-.5,0],[.5,-.5,0]],r.INDEX=[[0,1,2],[2,3,0]],r.NORMAL=[[0,0,1],[0,0,1],[0,0,1],[0,0,1]],r.TEXTURE_COORDINATE=[[1,1],[0,1],[0,0],[1,0]],e},_3DP_Helper.criticalError=function(e){this.setTimeout=_3DP_Helper.emptyFunction,alert("嚴重錯誤 程序停止\n\n"+e)},_3DP_Helper.degToRad=function(e){return Math.PI/180*e},_3DP_Helper.multiplyM4=function(e,r){return mat4.multiply([],e,r)},_3DP_Helper.dotV3=function(e,r){return vec3.dot(e,r)},_3DP_Helper.crossV3=function(e,r){return vec3.cross([],e,r)},_3DP_Helper.normalizeV3=function(e){return vec3.normalize([],e)},_3DP_Helper.lookAt=function(e,r,t){var n=[];return mat4.lookAt(n,e,r,t),n},_3DP_Helper.perspective=function(e,r,t,n){var o=[];return mat4.perspective(o,Math.PI/180*e,r,t,n),o},_3DP_Helper.createTransformMatrix=function(){return mat4.create()},_3DP_Helper.identity=function(e){return mat4.identity(e),e},_3DP_Helper.clone=function(e){return mat4.clone(e)},_3DP_Helper.copyTo=function(e,r){mat4.copy(r,e)},_3DP_Helper.translate=function(e,r){return mat4.translate([],e,r)},_3DP_Helper.scale=function(e,r){return mat4.scale([],e,r)},_3DP_Helper.rotate=function(e,r,t){return mat4.rotate([],e,t,r)},_3DP_Helper.rotateX=function(e,r){return mat4.rotateX([],e,r)},_3DP_Helper.rotateY=function(e,r){return mat4.rotateY([],e,r)},_3DP_Helper.rotateZ=function(e,r){return mat4.rotateZ([],e,r)},_3DP_Helper.flatArray=function(e){for(var r=[],t=0;t<e.length;t++)e[t]instanceof Array?r=r.concat(_3DP_Helper.flatArray(e[t])):r.push(e[t]);return r},_3DP_Helper.calculateTengent=function(e,r,t,n,o,i,a){var A=function(e,r){for(var t=[],n=0;n<e.length;n++)t[n]=e[n]-r[n];return t},l=function(e,r){for(var t=[],n=0;n<e.length;n++)t[n]=0==r?0:e[n]/r;return t},_=function(e,r,t,n,o,i){var a=[];if(0==t&&0==i)return a=l(A(e,n),1/(r-o)),r-o==0?[0,0,0]:_3DP_Helper.normalizeV3(a);var _=l(e,i),T=l(n,t),u=r*i,c=o*t;return a=l(A(_,T),1/(u-c)),u-c==0?[0,0,0]:_3DP_Helper.normalizeV3(a)},T=A(r,e),u=A(t,e),c=A(o,n),E=A(i,n),D=c[0],s=c[1],R=E[0],P=E[1];return D==R&&s==P?[0,0,0]:D==R&&0==D?_3DP_Helper.normalizeV3(_3DP_Helper.crossV3(a,_(T,s,D,u,P,R))):_(T,D,s,u,R,P)},_3DP_Helper.rayTest=function(e,r,t,n,o,i,a){i=i||0,a=a||1e3;var A=[];A[0]=!1,A[1]=0,A[2]=0,A[3]=0,A[4]=0;for(var l=[],_=[],T=0;;){for(var u=0;u<3;u++)l[u]=n[u]-t[u],_[u]=o[u]-t[u];if(!(_3DP_Helper.dotV3(l,_)<0))break;if(T>1)return alert("Can not find angle <= 90"),A;var c=[];c=t,t=o,o=n,n=c,T++}var E=[];_3DP_Helper.crossV3(l,_,E);var D=_3DP_Helper.dotV3(E,t),s,R,P=(-1*_3DP_Helper.dotV3(E,e)+D)/_3DP_Helper.dotV3(E,r);if(P<0||P<i||P>a)return A;for(var g=[],u=0;u<3;u++)g[u]=e[u]+r[u]*P;for(var f=[],u=0,C,K,h,M,m;u<3;u++)f[u]=g[u]-t[u];if(C=Math.sqrt(Math.pow(l[0],2)+Math.pow(l[1],2)+Math.pow(l[2],2)),K=Math.sqrt(Math.pow(_[0],2)+Math.pow(_[1],2)+Math.pow(_[2],2)),(h=Math.sqrt(Math.pow(f[0],2)+Math.pow(f[1],2)+Math.pow(f[2],2)))>C&&h>K)return A;if(M=_3DP_Helper.dotV3(f,l)/C,m=_3DP_Helper.dotV3(f,_)/K,M<0||m<0)return A;if(M>C||m>K)return A;_3DP_Helper.normalizeV3(l),_3DP_Helper.normalizeV3(_),_3DP_Helper.normalizeV3(f);var d=_3DP_Helper.dotV3(l,_);return _3DP_Helper.dotV3(f,l)<d||_3DP_Helper.dotV3(f,_)<d?A:M/C+m/K>2?A:(A[0]=!0,A[1]=g[0],A[2]=g[1],A[3]=g[2],A[4]=P,A)},extend(_3DP_CameraManager,_3DP_BaseComponent),extend(_3DP_CanvasController,_3DP_BaseComponent),extend(_3DP_FileLoader,_3DP_BaseComponent),extend(_3DP_FrameController,_3DP_BaseComponent),extend(_3DP_ModelManager,_3DP_BaseComponent),extend(_3DP_RenderController,_3DP_BaseComponent),extend(_3DP_ResourceManager,_3DP_BaseComponent),extend(_3DP_SceneManager,_3DP_BaseComponent),extend(_3DP_ShaderManager,_3DP_BaseComponent),extend(_3DP_TextureManager,_3DP_BaseComponent),this.setTimeout=setTimeout||window.setTimeout,this.Math=Math,this.console.log=console.log,this.alert=alert,this.FloatArray=Float32Array,this.IntArray=Int32Array,this.UintArray=Uint16Array;var _3DP_TYPE={CANVAS:null,MODEL:null,TEXTURE:null,SHADER:null,CAMERA:null,RENDER_OBJECT:null},enumCount=1;for(var i in _3DP_TYPE)_3DP_TYPE[i]=enumCount,enumCount++;var _3DP_SHADER_INPUT={FLOAT:0,FLOAT2:1,FLOAT3:2,FLOAT4:3,FLOAT_VECTOR:4,FLOAT2_VECTOR:5,FLOAT3_VECTOR:6,FLOAT4_VECTOR:7,INT:8,INT2:9,INT3:10,INT4:11,INT_VECTOR:12,INT2_VECTOR:13,INT3_VECTOR:14,INT4_VECTOR:15,MATRIX2:16,MATRIX3:17,MATRIX4:18,TEXTURE:19,VERTEX_ATTRIBUTE:20},_3DP_GLOBAL_ID=0,setId=function(){return _3DP_GLOBAL_ID+=1},_3DP_Helper;function _3DP_BaseComponent(){this._3DP_ID=null,this._3DP_TYPE=null,this.init=function(){}}function _3DP_Canvas(e){var r={ID:setId(),TYPE:_3DP_TYPE.CANVAS,RAWDATA:null,RESOURCE:null};this.init=function(){this._3DP_ID=r.ID,this._3DP_TYPE=r.TYPE},this.get3DPId=function(){return r.ID},this.get3DPType=function(){return r.TYPE},this.getCanvas=function(){return r.RAWDATA},this.getWebGL=function(){return r.RESOURCE},this.getMember=function(){return r},this.init()}function _3DP_Resource(){this.isUsing=!1,this.countUse=0}function _3DP_Camera(){var e={ID:setId(),TYPE:_3DP_TYPE.CAMERA};this.init=function(){this._3DP_ID=e.ID,this._3DP_TYPE=e.TYPE},this.get3DPId=function(){return e.ID},this.get3DPType=function(){return e.TYPE},this.getMember=function(){return e},this.getViewMatrix=function(){return _3DP_Helper.lookAt(this.position,this.lookAt,this.up)},this.getProjectionMatrix=function(e){return e=e||1,_3DP_Helper.perspective(this.viewAngle,e,this.neapPlane,this.farPlane)},this.position=[0,0,10],this.up=[0,1,0],this.lookAt=[0,0,0],this.viewAngle=45,this.neapPlane=.001,this.farPlane=1e3,this.viewportStartX=0,this.viewportStartY=0,this.viewportEndX=null,this.viewportEndY=null,this.active=!0,this.init()}function _3DP_Model(){var e={ID:setId(),TYPE:_3DP_TYPE.MODEL,RAWDATA:{VERTEX:[],NORMAL:[],TEXTURE_COORDINATE:[],INDEX:[],EXTRA:{}},RESOURCE:{VERTEX:null,NORMAL:null,TEXTURE_COORDINATE:null,INDEX:null,EXTRA:{}}};this.init=function(){this._3DP_ID=e.ID,this._3DP_TYPE=e.TYPE},this.get3DPId=function(){return e.ID},this.get3DPType=function(){return e.TYPE},this.getMember=function(){return e},this.getModelRawData=function(){return e.RAWDATA},this.setExtraData=function(r,t){t.length==e.RAWDATA.VERTEX.length?e.RAWDATA.EXTRA[r]=t:console.log("Vertex額外資料數量必須與vertex數量相同，未設定任何資料")},this.getExtraData=function(r){return e.RESOURCE.EXTRA[r]},this.init()}function _3DP_Texture(){var e={ID:setId(),TYPE:_3DP_TYPE.TEXTURE,RAWDATA:null,RESOURCE:null};this.init=function(){this._3DP_ID=e.ID,this._3DP_TYPE=e.TYPE},this.get3DPId=function(){return e.ID},this.get3DPType=function(){return e.TYPE},this.getMember=function(){return e},this.init()}function _3DP_Shader(){var e={ID:setId(),TYPE:_3DP_TYPE.SHADER,RAWDATA:{VERTEX_SHADER:null,FRAGMENT_SHADER:null,SHADER_INPUT:{}},RESOURCE:{PROGRAM:null,LOC:{VERTEX:-1,NORMAL:-1,TEXTURE_COORDINATE:-1,TRANSFORM_MATRIX:null,VIEW_MATRIX:null,PROJECTION_MATRIX:null,SHADER_INPUT:{}}}};this.init=function(){this._3DP_ID=e.ID,this._3DP_TYPE=e.TYPE},this.get3DPId=function(){return e.ID},this.get3DPType=function(){return e.TYPE},this.getMember=function(){return e},this.init()}function _3DP_RenderObject(){var e={ID:setId(),TYPE:_3DP_TYPE.RENDER_OBJECT,ELEMENT:{MODEL:null,SHADER:null,SHADER_INPUT:{},TRANSFORM_MATRIX:[]}};this.init=function(){this._3DP_ID=e.ID,this._3DP_TYPE=e.TYPE,e.ELEMENT.TRANSFORM_MATRIX=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]},this.get3DPId=function(){return e.ID},this.get3DPType=function(){return e.TYPE},this.getMember=function(){return e},this.setTransformMatrix=function(r){e.ELEMENT.TRANSFORM_MATRIX=r},this.getTransformMatrix=function(){return e.ELEMENT.TRANSFORM_MATRIX},this.setModel=function(r){_3DP_Helper.checkType(r,_3DP_TYPE.MODEL)?e.ELEMENT.MODEL=r:console.log(r+" 不是Model，使用預設Model")},this.setShader=function(r){_3DP_Helper.checkType(r,_3DP_TYPE.SHADER)?e.ELEMENT.SHADER=r:console.log(r+" 不是Shader，使用預設Shader")},this.setShaderInput=function(r,t){e.ELEMENT.SHADER_INPUT[r]={},e.ELEMENT.SHADER_INPUT[r].DATA=t},this.clearShaderInput=function(){e.ELEMENT.SHADER_INPUT={}},this.active=!0,this.init()}function wizard(e){var r={cameraManager:null,canvasController:null,fileLoader:null,frameController:null,modelManager:null,renderController:null,resourceManager:null,sceneManager:null,shaderManager:null,textureManager:null};r.canvasController=new _3DP_CanvasController,r.canvasController.init(e),r.renderController=new _3DP_RenderController,r.renderController.init(r.canvasController),r.cameraManager=new _3DP_CameraManager,r.cameraManager.init(),r.fileLoader=new _3DP_FileLoader,r.fileLoader.init(),r.frameController=new _3DP_FrameController,r.frameController.init(r.renderController),r.modelManager=new _3DP_ModelManager,r.modelManager.init(r.canvasController),r.resourceManager=new _3DP_ResourceManager,r.resourceManager.init(),r.sceneManager=new _3DP_SceneManager,r.sceneManager.init(),r.shaderManager=new _3DP_ShaderManager,r.shaderManager.init(r.canvasController),r.textureManager=new _3DP_TextureManager,r.textureManager.init(r.canvasController),this.getCameraManager=function(){return r.cameraManager},this.getCanvasController=function(){return r.canvasController},this.getFileLoader=function(){return r.fileLoader},this.getFrameController=function(){return r.frameController},this.getModelManager=function(){return r.modelManager},this.getRenderController=function(){return r.renderController},this.getResourceManager=function(){return r.resourceManager},this.getSceneManager=function(){return r.sceneManager},this.getShaderManager=function(){return r.shaderManager},this.getTextureManager=function(){return r.textureManager}}function _3DP_CameraManager(){var e={maintainList:{},cameraList:[]};this.add=function(r){e.maintainList[r._3DP_ID]=r,e.cameraList.push(r)},this.remove=function(r){delete e.maintainList[r._3DP_ID]},this.refreshCameraList=function(){var r=e.cameraList,t=e.maintainList;for(var n in r=[],t)r.push(t[n])},this.sortCameraList=function(){},this.getCameraList=function(){return e.cameraList}}function _3DP_CanvasController(){var e={canvas:null};this.init=function(r){for(var t=["webgl","webkit-3d","moz-webgl","experimental-webgl"],n=!1,o=0;o<4;o++){try{var n=r.getContext(t[o])}catch(e){console.log(e),n=!1}if(n)break}if(!n)return _3DP_Helper.criticalError("此瀏覽器不支援WebGL，請改用有支援的瀏覽器。如Chrome"),!1;var i=new _3DP_Canvas;i.getMember().RAWDATA=r,i.getMember().RESOURCE=n,e.canvas=i},this.getCanvas=function(){return e.canvas}}function _3DP_FileLoader(){var e={callBack:null};this.init=function(){e.callBack=function(e,r){console.log("未設置callback function, 格式為fun(_result, _argArray)")}},this.loadObjModel=async function(r,t,n){t=t||e.callBack;let o=await fetch(r),i;for(var a=await o.text(),A=[],l=[],_=[],T=[],u=/v\s.*/g,c=/vt\s.*/g,E=/vn\s.*/g,D=/f\s.*/g,s=a.match(u),R=a.match(c),P=a.match(E),g=a.match(D),f=0;f<s.length;f++){var C=s[f].match(/[-.0-9]+/g);s[f]=[1*C[0],1*C[1],1*C[2]]}for(var f=0;f<R.length;f++){var C=R[f].match(/[-.0-9]+/g);R[f]=[1*C[0],1*C[1]]}for(var f=0;f<P.length;f++){var C=P[f].match(/[-.0-9]+/g);P[f]=[1*C[0],1*C[1],1*C[2]]}for(var f=0;f<g.length;f++){for(var C,K=(C=g[f].match(/[\/0-9]+/g)).length,h=0;h<K;h++){var M=C[h].split("/");A.push(s[1*M[0]-1]),R.length>0?l.push(R[1*M[1]-1]):l.push([0,0]),P.length>0?_.push(P[1*M[2]-1]):_.push([0,0,0])}for(var m=A.length,d=K-2,h=0;h<d;h++){var O=m-K;T.push([O,O+h+1,O+h+2])}}var I=new _3DP_Model,v=I.getMember().RAWDATA;v.VERTEX=A,v.TEXTURE_COORDINATE=l,v.NORMAL=_,v.INDEX=T,t(I,n=n||[])},this.loadShader=async function(r,t,n,o){n=n||e.callBack;var i=new _3DP_Shader,a=i.getMember().RAWDATA;let A=await fetch(r),l=await fetch(t);a.VERTEX_SHADER=await A.text(),a.FRAGMENT_SHADER=await l.text(),n(i,o=o||[])},this.loadTexture=function(r,t,n){t=t||e.callBack;var o=new Image;o.onload=function(){var e=new _3DP_Texture;e.getMember().RAWDATA=o,t(e,n=n||[])},o.src=r},this.init()}function _3DP_FrameController(){var e={renderController:null,frameFun:_3DP_Helper.emptyFunction,timeoutFun:null,frameStartTime:0,everFrameWaitTime:33,isPlay:!1,calculateFPSFun:null,isCalculateFPS:!1,FPS:0,countFPS:0,preFPSTime:0};this.init=function(r){e.renderController=r},this.setFPS=function(r){e.everFrameWaitTime=r<=0?1e3:Math.round(1e3/r)},e.calculateFPSFun=function(){e.countFPS++;var r=e.countFPS,t=_3DP_Helper.getTime()-e.preFPSTime;t>=1e3&&(e.preFPSTime=_3DP_Helper.getTime(),e.countFPS=0),t<=0&&(t=1),e.FPS=Math.round(r/t*1e5)/100},this.FPS=function(){return e.FPS},this.calculateFPS=function(r){r?e.isCalculateFPS=!0:(e.isCalculateFPS=!1,e.FPS=0,e.countFPS=0)},this.setFrameFunction=function(r){e.frameFun=r},e.timeoutFun=function(){var r=e.renderController;if(0!=e.isPlay&&null!=r){e.frameStartTime=_3DP_Helper.getTime(),e.frameFun(),r.renderAll(),r.waitComplete(),e.isCalculateFPS&&e.calculateFPSFun();var t=e.everFrameWaitTime-(_3DP_Helper.getTime()-e.frameStartTime);setTimeout(e.timeoutFun,t)}else null==r&&_3DP_Helper.criticalError("_3DP_FrameController未完成初始化，_3DP_FrameController.init(instance _3DP_RenderController)")},this.start=function(){e.isPlay=!0,e.timeoutFun()},this.stop=function(){e.isPlay=!1}}function _3DP_ModelManager(){var e={canvas:null,DEFAULT:null,createBuffer:null};this.init=function(r){e.canvas=r.getCanvas();var t=_3DP_Helper.createPlane();e.DEFAULT=this.add(t)},e.createBuffer=function(r,t,n){n=n||!1;var o=e.canvas.getWebGL(),i=o.createBuffer(),a=_3DP_Helper.flatArray(r);return n?(o.bindBuffer(o.ELEMENT_ARRAY_BUFFER,i),o.bufferData(o.ELEMENT_ARRAY_BUFFER,new t(a),o.STATIC_DRAW),i.SIZE=a.length,i):(o.bindBuffer(o.ARRAY_BUFFER,i),o.bufferData(o.ARRAY_BUFFER,new t(a),o.STATIC_DRAW),i.SIZE=r[0].length,i)},this.add=function(r){if(!_3DP_Helper.checkType(r,_3DP_TYPE.MODEL))return console.log(r+" ,ModelManager不支援的資料類別，使用預設資源"),e.DEFAULT;var t=r.getMember().RESOURCE,n=r.getMember().RAWDATA;if(null==n.VERTEX||null==n.INDEX)return console.log(r+" ,Model資料不完整，使用預設資源"),e.DEFAULT;for(var o in t.VERTEX=e.createBuffer(n.VERTEX,FloatArray),t.INDEX=e.createBuffer(n.INDEX,UintArray,!0),null!=n.NORMAL&&(t.NORMAL=e.createBuffer(n.NORMAL,FloatArray)),null!=n.TEXTURE_COORDINATE&&(t.TEXTURE_COORDINATE=e.createBuffer(n.TEXTURE_COORDINATE,FloatArray)),n.EXTRA)t.EXTRA[o]=e.createBuffer(n.EXTRA[o],FloatArray);return r},this.remove=function(e){if(_3DP_Helper.checkType(e,_3DP_TYPE.MODEL))var r=e.getResource();else console.log(e+" ,ModelManager不支援的資料類別，未移除任何資源")}}function _3DP_RenderController(){var e={canvas:null,draw:null,renderPreProcess:null,shaderInput:null,textureUnitArray:[],renderList:[],cameraList:[],randerTarget:null,cameraCheck:!0,renderObjectCheck:!0};this.init=function(r){e.canvas=r.getCanvas();var t=e.canvas.getWebGL();t.enable(t.DEPTH_TEST),t.frontFace(t.CCW),t.disable(t.CULL_FACE),t.cullFace(t.BACK);for(var n=0;n<t.getParameter(t.MAX_COMBINED_TEXTURE_IMAGE_UNITS);n++)e.textureUnitArray.push(t.TEXTURE0+n);this.setClearFrame(!0,!0,!1)},this.setRenderObjectList=function(r){r instanceof Array?e.renderList=r:console.log("RenderController.setRenderObjectList(array of instance _3DP_RenderObject)錯誤，輸入為Array資料類別，未輸入任何資料")},this.setCameraList=function(r){r instanceof Array?e.cameraList=r:console.log("RenderController.setCameraList(array of instance _3DP_Camera)錯誤，輸入為Array資料類別，未輸入任何資料")},e.shaderInput=function(r){var t=e.canvas.getWebGL(),n=r.SHADER.getMember().RESOURCE.LOC.SHADER_INPUT,o=r.SHADER_INPUT,i=_3DP_SHADER_INPUT,a=0;for(var A in n)if(null!=o[A])switch(n[A].TYPE){case i.FLOAT:t.uniform1f(n[A].LOC,o[A].DATA);break;case i.FLOAT2:t.uniform2f(n[A].LOC,o[A].DATA[0],o[A].DATA[1]);break;case i.FLOAT3:t.uniform3f(n[A].LOC,o[A].DATA[0],o[A].DATA[1],o[A].DATA[2]);break;case i.FLOAT4:t.uniform4f(n[A].LOC,o[A].DATA[0],o[A].DATA[1],o[A].DATA[2],o[A].DATA[3]);break;case i.FLOAT_VECTOR:t.uniform1fv(n[A].LOC,_3DP_Helper.flatArray(o[A].DATA));break;case i.FLOAT2_VECTOR:t.uniform2fv(n[A].LOC,_3DP_Helper.flatArray(o[A].DATA));break;case i.FLOAT3_VECTOR:t.uniform3fv(n[A].LOC,_3DP_Helper.flatArray(o[A].DATA));break;case i.FLOAT4_VECTOR:t.uniform4fv(n[A].LOC,_3DP_Helper.flatArray(o[A].DATA));break;case i.INT:t.uniform1i(n[A].LOC,o[A].DATA);break;case i.INT2:t.uniform2i(n[A].LOC,o[A].DATA[0],o[A].DATA[1]);break;case i.INT3:t.uniform3i(n[A].LOC,o[A].DATA[0],o[A].DATA[1],o[A].DATA[2]);break;case i.INT4:t.uniform4i(n[A].LOC,o[A].DATA[0],o[A].DATA[1],o[A].DATA[2],o[A].DATA[3]);break;case i.INT_VECTOR:t.uniform1iv(n[A].LOC,_3DP_Helper.flatArray(o[A].DATA));break;case i.INT2_VECTOR:t.uniform2iv(n[A].LOC,_3DP_Helper.flatArray(o[A].DATA));break;case i.INT3_VECTOR:t.uniform3iv(n[A].LOC,_3DP_Helper.flatArray(o[A].DATA));break;case i.INT4_VECTOR:t.uniform4iv(n[A].LOC,_3DP_Helper.flatArray(o[A].DATA));break;case i.MATRIX2:t.uniformMatrix2fv(n[A].LOC,_3DP_Helper.flatArray(o[A].DATA));break;case i.MATRIX3:t.uniformMatrix3fv(n[A].LOC,_3DP_Helper.flatArray(o[A].DATA));break;case i.MATRIX4:t.uniformMatrix4fv(n[A].LOC,_3DP_Helper.flatArray(o[A].DATA));break;case i.TEXTURE:var l=e.textureUnitArray;if(a>=l.length){console.log("Texture最多只能"+l.length+"張");break}t.activeTexture(l[a]),t.bindTexture(t.TEXTURE_2D,o[A].DATA.getMember().RESOURCE),t.uniform1i(n[A].LOC,a),a+=1;break;case i.VERTEX_ATTRIBUTE:var _=r.MODEL.getMember().RESOURCE.EXTRA[A];n[A].LOC>-1&&null!=_&&(t.bindBuffer(t.ARRAY_BUFFER,_),t.vertexAttribPointer(n[A].LOC,_.SIZE,t.FLOAT,!1,0,0))}},e.draw=function(r,t,n){var o=e.canvas.getWebGL(),i=r.MODEL.getMember().RESOURCE,a=i.VERTEX,A=i.INDEX,l=i.NORMAL,_=i.TEXTURE_COORDINATE,T=r.SHADER.getMember().RESOURCE.LOC;o.useProgram(r.SHADER.getMember().RESOURCE.PROGRAM),o.bindBuffer(o.ARRAY_BUFFER,a),o.vertexAttribPointer(T.VERTEX,a.SIZE,o.FLOAT,!1,0,0),T.NORMAL>-1&&null!=l&&(o.bindBuffer(o.ARRAY_BUFFER,l),o.vertexAttribPointer(T.NORMAL,l.SIZE,o.FLOAT,!1,0,0)),T.TEXTURE_COORDINATE>-1&&null!=_&&(o.bindBuffer(o.ARRAY_BUFFER,_),o.vertexAttribPointer(T.TEXTURE_COORDINATE,_.SIZE,o.FLOAT,!1,0,0)),o.uniformMatrix4fv(T.TRANSFORM_MATRIX,!1,r.TRANSFORM_MATRIX),o.uniformMatrix4fv(T.VIEW_MATRIX,!1,t),o.uniformMatrix4fv(T.PROJECTION_MATRIX,!1,n),o.bindBuffer(o.ELEMENT_ARRAY_BUFFER,A),e.shaderInput(r),o.drawElements(o.TRIANGLES,A.SIZE,o.UNSIGNED_SHORT,0)},e.renderPreProcess=function(r,t){for(var n=e.renderList,o=n.length,i=0;i<o;i++)if(0!=n[i].active){var a=n[i].getMember().ELEMENT;if(o<=0)return void(e.renderObjectCheck&&(console.log("RenderController未設置任何RenderObject，RenderController.setRenderObjectList(array of instance _3DP_RenderObject)"),e.renderObjectCheck=!1));null!=a.MODEL&&null!=a.SHADER?e.draw(a,r,t):(console.log(n[i]+"Render Object資料不完整, 停止處理此物件"),n[i].active=!1)}},this.renderAll=function(){var r=e.cameraList,t=e.cameraList.length,n=e.renderPreProcess;if(t<=0)e.cameraCheck&&(console.log("RenderController未設置任何攝影機，RenderController.setCameraList(array of instance _3DP_Camera)"),e.cameraCheck=!1);else for(var o=e.canvas.getWebGL(),i=0;i<t;i++){var a=r[i].viewportStartX,A=r[i].viewportEndX,l=r[i].viewportStartY,_=r[i].viewportEndY;null==A&&(r[i].viewportEndX=e.canvas.getCanvas().width),null==_&&(r[i].viewportEndY=e.canvas.getCanvas().height),o.viewport(a,l,A,_),n(r[i].getViewMatrix(),r[i].getProjectionMatrix(Math.abs((A-a)/(_-l))))}},this.waitComplete=function(){},this.setClearFrame=function(r,t,n){var o=e.canvas.getWebGL();r&&o.clear(o.COLOR_BUFFER_BIT),t&&o.clear(o.DEPTH_BUFFER_BIT),n&&o.clear(o.STENCIL_BUFFER_BIT)},this.setRanderTarget=function(r){e.randerTarget=r},this.getRanderTarget=function(){return e.randerTarget},this.assignRanderTarget=function(){var r=e.canvas.getWebGL();r.bindFramebuffer(r.FRAMEBUFFER,e.randerTarget)}}function _3DP_ResourceManager(){this.init=function(){},this.remove=function(e){}}function _3DP_SceneManager(){var e={maintainList:{},renderObjectList:[]};this.add=function(r){_3DP_Helper.checkType(r,_3DP_TYPE.RENDER_OBJECT)?(e.maintainList[r.get3DPId()]=r,e.renderObjectList.push(r)):console.log(r+" SceneManager不支援的資料類別，未加入任何資源")},this.remove=function(r){delete e.maintainList[r.get3DPId()]},this.clear=function(){e.renderObjectList=[]},this.refreshRenderObjectList=function(){var r=e.renderObjectList,t=e.maintainList;for(var n in r=[],t)r.push(t[n])},this.sortRenderObjectList=function(){},this.getRenderObjectList=function(){return e.renderObjectList}}function _3DP_ShaderManager(){var e={canvas:null,DEFAULT:null,compileShader:null,programShader:null,getShaderLoc:null,shaderInputProcess:null,defaultVS:null,defaultFS:null,defaultVS:function(){var e;return"attribute vec3 aVertex;uniform mat4 uTransformMatrix;uniform mat4 uViewMatrix;uniform mat4 uProjectionMatrix;void main(void) {gl_Position = uProjectionMatrix * uViewMatrix * uTransformMatrix * vec4(aVertex, 1.0);}"},defaultFS:function(){var e;return"void main(void) {gl_FragColor = vec4(1.0, 0.0, 1.0, 1.0);}"}};this.init=function(r){e.canvas=r.getCanvas();var t=new _3DP_Shader,n=t.getMember().RAWDATA;n.VERTEX_SHADER=e.defaultVS(),n.FRAGMENT_SHADER=e.defaultFS(),e.DEFAULT=this.add(t)},e.compileShader=function(r,t){var n=e.canvas.getWebGL(),o=n.createShader(t);return n.shaderSource(o,r),n.compileShader(o),n.getShaderParameter(o,n.COMPILE_STATUS)?o:(console.log(n.getShaderInfoLog(o)),!1)},e.programShader=function(r,t){var n=e.canvas.getWebGL(),o=n.createProgram();return n.attachShader(o,r),n.attachShader(o,t),n.linkProgram(o),n.detachShader(o,r),n.detachShader(o,t),o},e.getShaderLoc=function(r){var t=e.canvas.getWebGL(),n=r.getMember().RESOURCE.PROGRAM,o=r.getMember().RESOURCE.LOC;if(o.VERTEX=t.getAttribLocation(n,"aVertex"),o.VERTEX<0)return console.log(r+" ,Shader沒有 aVertex 變數，此為必要變數，使用預設資源"),void(r=e.DEFAULT);if(o.NORMAL=t.getAttribLocation(n,"aNormal"),o.TEXTURE_COORDINATE=t.getAttribLocation(n,"aTextureCoordinate"),o.VERTEX>-1&&t.enableVertexAttribArray(o.VERTEX),o.NORMAL>-1&&t.enableVertexAttribArray(o.NORMAL),o.TEXTURE_COORDINATE>-1&&t.enableVertexAttribArray(o.TEXTURE_COORDINATE),o.TRANSFORM_MATRIX=t.getUniformLocation(n,"uTransformMatrix"),null==o.TRANSFORM_MATRIX)return console.log(r+" ,Shader沒有 uTransformMatrix 變數，此為必要變數，使用預設資源"),void(r=e.DEFAULT);if(o.VIEW_MATRIX=t.getUniformLocation(n,"uViewMatrix"),null==o.VIEW_MATRIX)return console.log(r+" ,Shader沒有 uViewMatrix 變數，此為必要變數，使用預設資源"),void(r=e.DEFAULT);if(o.PROJECTION_MATRIX=t.getUniformLocation(n,"uProjectionMatrix"),null==o.PROJECTION_MATRIX)return console.log(r+" ,Shader沒有 uProjectionMatrix 變數，此為必要變數，使用預設資源"),void(r=e.DEFAULT);var i=r.getMember().RAWDATA.SHADER_INPUT,a=r.getMember().RESOURCE.LOC.SHADER_INPUT,A=_3DP_SHADER_INPUT;for(var l in i)a[l]={},a[l].TYPE=i[l].TYPE,a[l].TYPE==A.VERTEX_ATTRIBUTE?(a[l].LOC=t.getAttribLocation(n,l),a[l].LOC>-1&&t.enableVertexAttribArray(a[l].LOC)):a[l].LOC=t.getUniformLocation(n,l)},e.shaderInputProcess=function(e){var r=e.getMember().RAWDATA.VERTEX_SHADER,t=e.getMember().RAWDATA.FRAGMENT_SHADER,n=e.getMember().RAWDATA.SHADER_INPUT,o=_3DP_SHADER_INPUT,i=function(e){return(r.match(e)||[]).concat(t.match(e)||[])},a=function(e,r){for(var t=[],o=0;o<r.length;o++){var i=r[o].match(/[0-9a-zA-Z_]+/g)||[];i.shift(),t=t.concat(i)}for(var o=0;o<t.length;o++)n[t[o]]={},n[t[o]].TYPE=e},A={};for(var l in A[o.FLOAT]=i(/#3DP_FLOAT\s+.*/g),A[o.FLOAT2]=i(/#3DP_FLOAT2\s+.*/g),A[o.FLOAT3]=i(/#3DP_FLOAT3\s+.*/g),A[o.FLOAT4]=i(/#3DP_FLOAT4\s+.*/g),A[o.FLOAT_VECTOR]=i(/#3DP_FLOAT_VECTOR\s+.*/g),A[o.FLOAT2_VECTOR]=i(/#3DP_FLOAT2_VECTOR\s+.*/g),A[o.FLOAT3_VECTOR]=i(/#3DP_FLOAT3_VECTOR\s+.*/g),A[o.FLOAT4_VECTOR]=i(/#3DP_FLOAT4_VECTOR\s+.*/g),A[o.INT]=i(/#3DP_INT\s+.*/g),A[o.INT2]=i(/#3DP_INT2\s+.*/g),A[o.INT3]=i(/#3DP_INT3\s+.*/g),A[o.INT4]=i(/#3DP_INT4\s+.*/g),A[o.INT_VECTOR]=i(/#3DP_INT_VECTOR\s+.*/g),A[o.INT2_VECTOR]=i(/#3DP_INT2_VECTOR\s+.*/g),A[o.INT3_VECTOR]=i(/#3DP_INT3_VECTOR\s+.*/g),A[o.INT4_VECTOR]=i(/#3DP_INT4_VECTOR\s+.*/g),A[o.MATRIX2]=i(/#3DP_MATRIX2\s+.*/g),A[o.MATRIX3]=i(/#3DP_MATRIX3\s+.*/g),A[o.MATRIX4]=i(/#3DP_MATRIX4\s+.*/g),A[o.TEXTURE]=i(/#3DP_TEXTURE\s+.*/g),A[o.VERTEX_ATTRIBUTE]=i(/#3DP_VERTEX_ATTRIBUTE\s+.*/g),A)a(parseInt(l),A[l])},this.add=function(r){if(!_3DP_Helper.checkType(r,_3DP_TYPE.SHADER))return console.log(r+" ShaderManager不支援的資料類別，使用預設資源"),e.DEFAULT;var t=e.canvas.getWebGL(),n=r.getMember().RAWDATA,o=e.compileShader(n.VERTEX_SHADER,t.VERTEX_SHADER);o||console.log(r+",vertex shader編譯錯誤");var i=e.compileShader(n.FRAGMENT_SHADER,t.FRAGMENT_SHADER);return i||console.log(r+",fragment shader編譯錯誤"),o&&i?(e.shaderInputProcess(r),r.getMember().RESOURCE.PROGRAM=e.programShader(o,i),e.getShaderLoc(r),r):(console.log("Shader編譯錯誤，使用預設資源"),e.DEFAULT)},this.remove=function(e){if(_3DP_Helper.checkType(e,_3DP_TYPE.SHADER))if(e.get3DPId()!=DEFAULTID)var r=e.getResource();else console.log(e+" 為預設資源，不可移除");else console.log(e+" ShaderManager不支援的資料類別，未移除任何資源")}}function _3DP_TextureManager(){var e={canvas:null,createBuffer:null,maintainList:{},DEFAULT:null};this.init=function(r){e.canvas=r.getCanvas(),e.DEFAULT=new _3DP_Texture;var t=new Image;t.src="data:image/jpg;base64,/9j/4AAQSkZJRgABAQEAYABgAAD/4QBeRXhpZgAATU0AKgAAAAgABFEAAAQAAAABAAAAAFEBAAMAAAABAAEAAFECAAEAAAAYAAAAPlEDAAEAAAABAAAAAAAAAAD///8AAAAPDw/w8PD09PQdHR3i4uILCwv/2wBDAAIBAQIBAQICAgICAgICAwUDAwMDAwYEBAMFBwYHBwcGBwcICQsJCAgKCAcHCg0KCgsMDAwMBwkODw0MDgsMDAz/2wBDAQICAgMDAwYDAwYMCAcIDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAz/wAARCAEAAQADASIAAhEBAxEB/8QAHwAAAQUBAQEBAQEAAAAAAAAAAAECAwQFBgcICQoL/8QAtRAAAgEDAwIEAwUFBAQAAAF9AQIDAAQRBRIhMUEGE1FhByJxFDKBkaEII0KxwRVS0fAkM2JyggkKFhcYGRolJicoKSo0NTY3ODk6Q0RFRkdISUpTVFVWV1hZWmNkZWZnaGlqc3R1dnd4eXqDhIWGh4iJipKTlJWWl5iZmqKjpKWmp6ipqrKztLW2t7i5usLDxMXGx8jJytLT1NXW19jZ2uHi4+Tl5ufo6erx8vP09fb3+Pn6/8QAHwEAAwEBAQEBAQEBAQAAAAAAAAECAwQFBgcICQoL/8QAtREAAgECBAQDBAcFBAQAAQJ3AAECAxEEBSExBhJBUQdhcRMiMoEIFEKRobHBCSMzUvAVYnLRChYkNOEl8RcYGRomJygpKjU2Nzg5OkNERUZHSElKU1RVVldYWVpjZGVmZ2hpanN0dXZ3eHl6goOEhYaHiImKkpOUlZaXmJmaoqOkpaanqKmqsrO0tba3uLm6wsPExcbHyMnK0tPU1dbX2Nna4uPk5ebn6Onq8vP09fb3+Pn6/9oADAMBAAIRAxEAPwD8A6KKKACiiigAooooAKKKKACiiigAooooAKKKKACmyU6myUAf38SU2nSU2gAooooAKKKKACiiigAooooAKKKKACiiigAooooA/gLooooAKKKKACiiigAooooAKKKKACiiigAooooAKbJTqbJQB/fxJTadJTaACiiigAooooAKKKKACiiigAooooAKKKKACiiigD+AuiiigAooooAKKKKACiiigAooooAKKKKACiiigApslOpslAH9/ElNp0lNoAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAP4C6KKKACiiigAooooAKKKKACiiigAooooAKKKKACmyU6myUAf38SU2nSU2gAooooAKKKKACiiigAooooAKKKKACiiigAooooA/gLooooAKKKKACiiigAooooAKKKKACiiigAooooAKbJTqbJQB/fxJTadJTaACiiigAooooAKKKKACiiigAooooAKKKKACiiigD+AuiiigAooooAKKKKACiiigAooooAKKKKACiiigApslOpslAH9/ElNp0lNoAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAP4C6KKKACiiigAooooAKKKKACiiigAooooAKKKKACmyU6myUAf38SU2nSU2gAooooAKKKKACiiigAooooAKKKKACiiigAooooA/gLopvmUeZQA6im+ZR5lADqKb5lHmUAOopvmUeZQA6im+ZR5lADqKb5lHmUAOopvmUeZQA6myUeZSM26gD+/mSm09l3Unl0ANop3l0eXQA2ineXR5dADaKd5dHl0ANop3l0eXQA2ineXR5dADaKd5dHl0ANop3l0eXQA3z/b9aPP8Ab9ajooAk8/2/Wjz/AG/Wo6KAJPP9v1o8/wBv1qOigCTz/b9aPP8Ab9ajooAk8/2/Wjz/AG/Wo6KAJPP9v1o8/wBv1qOigCTz/b9aPP8Ab9ajooAk8/2/WnRyb6hqSD+KgD+AeiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA/v0ooooAKKKKACiiigAooooAKKKKACiiigAooooAKkg/iqOpIP4qAP4B6KKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD+/SiiigAooooAKKKKACiiigAooooAKKKKACiiigAqSD+Ko6kg/ioA/gHooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAP79KKKKACiiigAooooAKKKKACiiigAooooAKKKKACpIP4qjqSD+KgD+AeiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA/v0ooooAKKKKACiiigAooooAKKKKACiiigAooooAKkg/iqOpIP4qAP4B6KKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD+/SiiigAooooAKKKKACiiigAooooAKKKKACiiigAqSD+Ko6kg/ioA/gHooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAP79KKKKACiiigAooooAKKKKACiiigAooooAKKKKACpIP4qjqSD+KgD+AeiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooA/v0ooooAKKKKACiiigAooooAKKKKACiiigAooooAKkg/iqOpIP4qAP4B6KKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD//2Q==",e.DEFAULT.getMember().RAWDATA=t,this.add(e.DEFAULT)},e.createBuffer=function(r){var t=e.canvas.getWebGL(),n=t.createTexture();t.bindTexture(t.TEXTURE_2D,n),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!0),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,r.getMember().RAWDATA),r.getMember().RESOURCE=n,t.bindTexture(t.TEXTURE_2D,null)},this.add=function(r){return _3DP_Helper.checkType(r,_3DP_TYPE.TEXTURE)?(e.createBuffer(r),r):(console.log(r+" TextureManager不支援的資料類別，使用預設資源"),e.DEFAULT)}}extend(_3DP_Resource,_3DP_BaseComponent),extend(_3DP_Camera,_3DP_Resource),extend(_3DP_Model,_3DP_Resource),extend(_3DP_Texture,_3DP_Resource),extend(_3DP_Shader,_3DP_Resource),extend(_3DP_RenderObject,_3DP_Resource),(_3DP_Helper={}).emptyFunction=function(){},_3DP_Helper.checkType=function(e,r){return void 0!==(e=e||{}).get3DPType&&e.get3DPType()==r},_3DP_Helper.checkId=function(e){return void 0!==(e=e||{}).get3DPId&&e.get3DPId()},_3DP_Helper.getTime=function(){return(new Date).getTime()},_3DP_Helper.createPlane=function(){var e=new _3DP_Model,r=e.getMember().RAWDATA;return r.VERTEX=[[.5,.5,0],[-.5,.5,0],[-.5,-.5,0],[.5,-.5,0]],r.INDEX=[[0,1,2],[2,3,0]],r.NORMAL=[[0,0,1],[0,0,1],[0,0,1],[0,0,1]],r.TEXTURE_COORDINATE=[[1,1],[0,1],[0,0],[1,0]],e},_3DP_Helper.criticalError=function(e){this.setTimeout=_3DP_Helper.emptyFunction,alert("嚴重錯誤 程序停止\n\n"+e)},_3DP_Helper.degToRad=function(e){return Math.PI/180*e},_3DP_Helper.multiplyM4=function(e,r){return mat4.multiply([],e,r)},_3DP_Helper.dotV3=function(e,r){return vec3.dot(e,r)},_3DP_Helper.crossV3=function(e,r){return vec3.cross([],e,r)},_3DP_Helper.normalizeV3=function(e){return vec3.normalize([],e)},_3DP_Helper.lookAt=function(e,r,t){var n=[];return mat4.lookAt(n,e,r,t),n},_3DP_Helper.perspective=function(e,r,t,n){var o=[];return mat4.perspective(o,Math.PI/180*e,r,t,n),o},_3DP_Helper.createTransformMatrix=function(){return mat4.create()},_3DP_Helper.identity=function(e){return mat4.identity(e),e},_3DP_Helper.clone=function(e){return mat4.clone(e)},_3DP_Helper.copyTo=function(e,r){mat4.copy(r,e)},_3DP_Helper.translate=function(e,r){return mat4.translate([],e,r)},_3DP_Helper.scale=function(e,r){return mat4.scale([],e,r)},_3DP_Helper.rotate=function(e,r,t){return mat4.rotate([],e,t,r)},_3DP_Helper.rotateX=function(e,r){return mat4.rotateX([],e,r)},_3DP_Helper.rotateY=function(e,r){return mat4.rotateY([],e,r)},_3DP_Helper.rotateZ=function(e,r){return mat4.rotateZ([],e,r)},_3DP_Helper.flatArray=function(e){for(var r=[],t=0;t<e.length;t++)e[t]instanceof Array?r=r.concat(_3DP_Helper.flatArray(e[t])):r.push(e[t]);return r},_3DP_Helper.calculateTengent=function(e,r,t,n,o,i,a){var A=function(e,r){for(var t=[],n=0;n<e.length;n++)t[n]=e[n]-r[n];return t},l=function(e,r){for(var t=[],n=0;n<e.length;n++)t[n]=0==r?0:e[n]/r;return t},_=function(e,r,t,n,o,i){var a=[];if(0==t&&0==i)return a=l(A(e,n),1/(r-o)),r-o==0?[0,0,0]:_3DP_Helper.normalizeV3(a);var _=l(e,i),T=l(n,t),u=r*i,c=o*t;return a=l(A(_,T),1/(u-c)),u-c==0?[0,0,0]:_3DP_Helper.normalizeV3(a)},T=A(r,e),u=A(t,e),c=A(o,n),E=A(i,n),D=c[0],s=c[1],R=E[0],P=E[1];return D==R&&s==P?[0,0,0]:D==R&&0==D?_3DP_Helper.normalizeV3(_3DP_Helper.crossV3(a,_(T,s,D,u,P,R))):_(T,D,s,u,R,P)},_3DP_Helper.rayTest=function(e,r,t,n,o,i,a){i=i||0,a=a||1e3;var A=[];A[0]=!1,A[1]=0,A[2]=0,A[3]=0,A[4]=0;for(var l=[],_=[],T=0;;){for(var u=0;u<3;u++)l[u]=n[u]-t[u],_[u]=o[u]-t[u];if(!(_3DP_Helper.dotV3(l,_)<0))break;if(T>1)return alert("Can not find angle <= 90"),A;var c=[];c=t,t=o,o=n,n=c,T++}var E=[];_3DP_Helper.crossV3(l,_,E);var D=_3DP_Helper.dotV3(E,t),s,R,P=(-1*_3DP_Helper.dotV3(E,e)+D)/_3DP_Helper.dotV3(E,r);if(P<0||P<i||P>a)return A;for(var g=[],u=0;u<3;u++)g[u]=e[u]+r[u]*P;for(var f=[],u=0,C,K,h,M,m;u<3;u++)f[u]=g[u]-t[u];if(C=Math.sqrt(Math.pow(l[0],2)+Math.pow(l[1],2)+Math.pow(l[2],2)),K=Math.sqrt(Math.pow(_[0],2)+Math.pow(_[1],2)+Math.pow(_[2],2)),(h=Math.sqrt(Math.pow(f[0],2)+Math.pow(f[1],2)+Math.pow(f[2],2)))>C&&h>K)return A;if(M=_3DP_Helper.dotV3(f,l)/C,m=_3DP_Helper.dotV3(f,_)/K,M<0||m<0)return A;if(M>C||m>K)return A;_3DP_Helper.normalizeV3(l),_3DP_Helper.normalizeV3(_),_3DP_Helper.normalizeV3(f);var d=_3DP_Helper.dotV3(l,_);return _3DP_Helper.dotV3(f,l)<d||_3DP_Helper.dotV3(f,_)<d?A:M/C+m/K>2?A:(A[0]=!0,A[1]=g[0],A[2]=g[1],A[3]=g[2],A[4]=P,A)},extend(_3DP_CameraManager,_3DP_BaseComponent),extend(_3DP_CanvasController,_3DP_BaseComponent),extend(_3DP_FileLoader,_3DP_BaseComponent),extend(_3DP_FrameController,_3DP_BaseComponent),extend(_3DP_ModelManager,_3DP_BaseComponent),extend(_3DP_RenderController,_3DP_BaseComponent),extend(_3DP_ResourceManager,_3DP_BaseComponent),extend(_3DP_SceneManager,_3DP_BaseComponent),extend(_3DP_ShaderManager,_3DP_BaseComponent),extend(_3DP_TextureManager,_3DP_BaseComponent);